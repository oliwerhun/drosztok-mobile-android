<!DOCTYPE html>
<html lang="hu">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DROSZTOK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Landscape warning overlay -->
    <style>
        @media (orientation: landscape) and (max-width: 1024px) {
            body::before {
                content: 'üì± K√©rlek forgasd vissza a telefont √°ll√≥ helyzetbe!';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.95);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                font-size: 1.5rem;
                font-weight: bold;
                text-align: center;
                padding: 2rem;
            }
        }
    </style>

    <style>
        html,
        body {
            height: 100dvh;
            width: 100vw;
            overflow-x: hidden;
        }

        body {
            font-family: 'Inter', sans-serif;
            overflow-y: auto;
        }

        /* Action Buttons Responsive Positioning */
        .action-buttons-container {
            display: flex;
            gap: 1rem;
        }

        /* Mobile Portrait - Bottom Fixed */
        @media (max-width: 768px) {
            .action-buttons-container {
                position: fixed;
                bottom: 0.5rem;
                left: 0;
                right: 0;
                flex-direction: row;
                justify-content: space-between;
                align-items: stretch;
                gap: 0;
                padding: 0 1rem;
                margin: 0;
                background: transparent;
                z-index: 50;
                box-sizing: border-box;
            }

            .action-buttons-container button {
                flex: 1;
                height: 2.75rem !important;
                padding: 0 !important;
                margin: 0 !important;
                font-size: 0.875rem !important;
                border-radius: 0 !important;
                border: none !important;
                box-sizing: border-box;
            }

            /* Bal sz√©ls≈ë gomb - bal als√≥ √©s fels≈ë sarok lekerek√≠tve */
            .action-buttons-container button:first-child {
                border-bottom-left-radius: 0.5rem !important;
                border-top-left-radius: 0.5rem !important;
            }

            /* Jobb sz√©ls≈ë gomb - jobb als√≥ √©s fels≈ë sarok lekerek√≠tve */
            .action-buttons-container button:last-child {
                border-bottom-right-radius: 0.5rem !important;
                border-top-right-radius: 0.5rem !important;
            }

            .location-content-wrapper {
                padding-bottom: 2.75rem !important;
                margin-bottom: 0 !important;
            }

            /* Kont√©ner box alja igazodik a gombok tetej√©hez */
            .location-content-wrapper>div:first-child {
                margin-bottom: 0 !important;
            }
        }

        /* Desktop - Right Side */
        @media (min-width: 769px) {
            .action-buttons-container {
                flex-direction: column;
                justify-content: center;
                gap: 1rem;
            }
        }

        /* Tab Content Scroll */
        #tab-content {
            overflow-y: auto;
            height: 100%;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .sortable-ghost {
            opacity: 0.4;
            background-color: #dbeafe !important;
        }

        .sortable-drag {
            background-color: #eff6ff !important;
            border: 2px dashed #3b82f6 !important;
        }

        .member-item {
            cursor: grab;
            transition: transform 0.2s;
        }

        .member-item:active {
            cursor: grabbing;
            transform: scale(1.02);
        }

        .note-item {
            cursor: grab;
        }

        .note-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }

        .add-note-btn {
            transition: all 0.2s ease;
        }

        .add-note-btn:hover {
            transform: scale(1.1);
        }

        .orders-container {
            overflow-y: auto;
        }

        .kick-btn {
            opacity: 0;
            transition: opacity 0.2s;
            padding: 0.25rem;
            border-radius: 0.25rem;
        }

        .member-item:hover .kick-btn {
            opacity: 1;
        }

        .kick-btn:hover {
            background-color: rgba(254, 202, 202, 0.5);
        }

        .dark .kick-btn:hover {
            background-color: rgba(153, 27, 27, 0.5);
        }

        .drag-handle {
            cursor: grab;
            display: flex;
            align-items: center;
            padding: 0 0.5rem;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .drag-handle:hover {
            opacity: 1;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .driver-marker {
            background-color: #4f46e5;
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
        }

        html {
            font-size: 105%;
            font-weight: bold;
        }
    </style>
</head>

<body
    class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 antialiased transition-colors duration-300 h-full">

    <div id="dispatch-popup-container"></div>

    <div class="h-full">

        <div id="pre-auth-view" class="h-full flex flex-col items-center justify-center p-4">
            <header id="main-header" class="text-center mb-4">
                <h1 class="text-2xl sm:text-3xl font-bold text-indigo-600 dark:text-indigo-400">√údv√∂zl√ºnk az Oldalon!
                </h1>
                <p class="text-gray-600 dark:text-gray-400 mt-1 text-sm">Regisztr√°lj vagy jelentkezz be a folytat√°shoz
                </p>
            </header>

            <div id="auth-container" class="w-full max-w-md p-6 bg-white dark:bg-gray-800 rounded-2xl shadow-lg">
                <div class="mb-4">
                    <div class="flex border-b border-gray-200 dark:border-gray-700">
                        <button id="login-tab-button"
                            class="flex-1 py-2 text-center font-semibold text-indigo-600 dark:text-indigo-400 border-b-2 border-indigo-600 dark:border-indigo-400">Bejelentkez√©s</button>
                        <button id="register-tab-button"
                            class="flex-1 py-2 text-center font-semibold text-gray-500 dark:text-gray-400">Regisztr√°ci√≥</button>
                    </div>
                </div>

                <form id="login-form">
                    <div class="mb-3">
                        <label for="login-email"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email c√≠m</label>
                        <input type="email" id="login-email" required
                            class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition"
                            placeholder="pelda@email.com">
                    </div>
                    <div class="mb-4">
                        <label for="login-password"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jelsz√≥</label>
                        <div class="relative">
                            <input type="password" id="login-password" required
                                class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition pr-10">
                            <button type="button" id="toggle-login-password"
                                class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <svg id="eye-icon-login" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                <svg id="eye-slash-icon-login" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden"
                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button type="submit"
                        class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 dark:focus:ring-indigo-800 transition-transform transform hover:scale-105">
                        Bejelentkez√©s
                    </button>
                    <button type="button" id="forgot-password-btn"
                        class="w-full mt-2 text-sm text-indigo-600 dark:text-indigo-400 hover:underline">
                        Elfelejtett jelsz√≥?
                    </button>
                </form>

                <form id="register-form" class="hidden space-y-3">
                    <div>
                        <label for="register-email"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email c√≠m</label>
                        <input type="email" id="register-email" required
                            class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition"
                            placeholder="pelda@email.com">
                    </div>
                    <div>
                        <label for="register-callsign"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">H√≠v√≥sz√°m (3
                            sz√°mjegy)</label>
                        <input type="text" id="register-callsign" required maxlength="3" pattern="\d{3}"
                            title="A h√≠v√≥sz√°mnak pontosan 3 sz√°mb√≥l kell √°llnia."
                            class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition"
                            placeholder="000">
                    </div>
                    <div>
                        <label for="register-password"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jelsz√≥ (min. 6
                            karakter)</label>
                        <div class="relative">
                            <input type="password" id="register-password" required minlength="6"
                                class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition pr-10">
                            <button type="button" id="toggle-register-password"
                                class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <svg id="eye-icon-register" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                <svg id="eye-slash-icon-register" xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="register-license-plate"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Rendsz√°m</label>
                        <input type="text" id="register-license-plate" required
                            class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition"
                            placeholder="ABC123">
                    </div>
                    <div>
                        <label for="register-type"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">T√≠pus</label>
                        <select id="register-type" required
                            class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition">
                            <option value="" selected disabled>V√°lassz</option>
                            <option value="Taxi">Taxi</option>
                            <option value="Kombi Taxi">Kombi Taxi</option>
                            <option value="VIP">VIP</option>
                            <option value="VIP Kombi">VIP Kombi</option>
                            <option value="V-Oszt√°ly">V-Oszt√°ly</option>
                        </select>
                    </div>
                    <button type="submit"
                        class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 dark:focus:ring-indigo-800 transition-transform transform hover:scale-105 !mt-4">
                        Regisztr√°ci√≥
                    </button>
                </form>

                <div id="password-reset-form" class="hidden">
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Add meg az email c√≠med √©s k√ºld√ºnk egy
                        jelsz√≥ vissza√°ll√≠t√≥ linket.</p>
                    <div class="mb-4">
                        <label for="reset-email"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email c√≠m</label>
                        <input type="email" id="reset-email" required
                            class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition"
                            placeholder="pelda@email.com">
                    </div>
                    <button id="send-reset-btn"
                        class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 dark:focus:ring-indigo-800 transition-transform transform hover:scale-105">
                        K√ºld√©s
                    </button>
                    <button id="back-to-login-btn"
                        class="w-full mt-2 text-sm text-gray-600 dark:text-gray-400 hover:underline">
                        Vissza a bejelentkez√©shez
                    </button>
                </div>

                <div id="error-message" class="mt-3 text-center text-red-500 font-semibold text-sm"></div>
            </div>

            <div id="pending-approval-container"
                class="hidden w-full max-w-md p-6 text-center bg-white dark:bg-gray-800 rounded-2xl shadow-lg">
                <h2 class="text-xl font-bold mb-3">‚è≥ Adminisztr√°tori j√≥v√°hagy√°sra v√°r</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-4 text-sm">A fi√≥kod adminisztr√°tori j√≥v√°hagy√°sra v√°r.
                    K√©rj√ºk, l√©gy t√ºrelemmel.</p>
                <button id="pending-logout-button"
                    class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition">Kijelentkez√©s</button>
            </div>
        </div>

        <div id="dashboard-container" class="hidden w-full h-full p-4 sm:p-6 bg-white dark:bg-gray-800 flex flex-col">
            <div class="flex flex-row justify-between items-center w-full mb-4">
                <div class="flex items-center gap-3">
                    <h2 class="text-xl font-bold">DROSZTOK</h2>
                </div>
                <div class="text-right">
                    <p id="welcome-message" class="font-semibold text-sm">Szia!</p>
                    <button id="logout-button"
                        class="mt-1 text-xs text-red-600 dark:text-red-400 hover:underline">Kijelentkez√©s</button>
                </div>
            </div>

            <nav id="dashboard-nav" class="mb-4">
                <div class="border-b border-gray-200 dark:border-gray-700">
                    <ul class="flex -mb-px overflow-x-auto no-scrollbar" aria-label="Tabs">
                    </ul>
                </div>
            </nav>

            <div id="tab-content" class="p-1 min-h-[380px] flex-grow">
            </div>
        </div>

    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            sendPasswordResetEmail,
            sendEmailVerification,
            setPersistence,
            browserSessionPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            onSnapshot,
            updateDoc,
            arrayUnion,
            setDoc,
            getDoc,
            writeBatch,
            collection,
            getDocs,
            query,
            deleteDoc,
            serverTimestamp,
            where
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import {
            getFunctions,
            httpsCallable
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBbbdc2E3I_PMAF0eyZq_HK7Qdjz_3Xbw8",
            authDomain: "elitdroszt-597f4.firebaseapp.com",
            projectId: "elitdroszt-597f4",
            storageBucket: "elitdroszt-597f4.firebasestorage.app",
            messagingSenderId: "652103280844",
            appId: "1:652103280844:web:86f21e7800bf0cbeb17a69",
            measurementId: "G-W0GH2HRP1V"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);

        const preAuthView = document.getElementById('pre-auth-view');
        const mainHeader = document.getElementById('main-header');
        const authContainer = document.getElementById('auth-container');
        const dashboardContainer = document.getElementById('dashboard-container');
        const pendingApprovalContainer = document.getElementById('pending-approval-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const passwordResetForm = document.getElementById('password-reset-form');
        const loginTabButton = document.getElementById('login-tab-button');
        const registerTabButton = document.getElementById('register-tab-button');
        const forgotPasswordBtn = document.getElementById('forgot-password-btn');
        const backToLoginBtn = document.getElementById('back-to-login-btn');
        const sendResetBtn = document.getElementById('send-reset-btn');
        const logoutButton = document.getElementById('logout-button');
        const pendingLogoutButton = document.getElementById('pending-logout-button');
        const welcomeMessage = document.getElementById('welcome-message');
        const errorMessage = document.getElementById('error-message');
        const navUl = document.querySelector('#dashboard-nav ul');
        const tabContent = document.getElementById('tab-content');
        const dispatchPopupContainer = document.getElementById('dispatch-popup-container');

        const TABS = ['Akad√©mia', 'Belv√°ros', 'Budai', 'Conti', 'Crowne', 'Kozmo', 'Rept√©r'];
        const LOCATION_TITLES = {
            'Akad√©mia': 'Akad√©mia Sor',
            'Belv√°ros': 'Belv√°rosi Sor',
            'Budai': 'Budai Sor',
            'Conti': 'Conti Sor',
            'Crowne': 'Crowne Plaza Sor',
            'Kozmo': 'Kozmo Sor',
            'Rept√©r': 'Rept√©ri Sor',
            'V-Oszt√°ly': 'V-Oszt√°ly Sor',
            '213': '213-as Sor',
            'T√©rk√©p': 'T√©rk√©p',
            'C√≠mkioszt√≥': 'C√≠mkioszt√≥'
        };
        let activeTab = null;
        let unsubscribeLocationListener = null;
        let unsubscribeMapListener = null;
        let unsubscribeDispatchListener = null;
        let currentUserProfile = null;
        let lastCheckedOut = null;
        let sortableMembersInstance = null;
        let sortableNotesInstance = null;
        let vClassNotes = [''];
        let vClassMembers = [];
        let vClassActiveSubTab = 'members';
        let airportMembers = [];
        let emiratesMembers = [];
        let airportNotes = [''];
        let airportActiveSubTab = 'airport';
        let p213Notes = [''];

        let locationWatcherId = null;
        let lastLocationUpdateTime = 0;
        const geofencedLocations = {
            'Akad√©mia': {
                polygon: [
                    { lat: 47.505695, lng: 19.049845 },
                    { lat: 47.506827, lng: 19.049527 },
                    { lat: 47.507495, lng: 19.055352 },
                    { lat: 47.497514, lng: 19.055229 },
                    { lat: 47.496632, lng: 19.049139 },
                    { lat: 47.492195, lng: 19.051646 },
                    { lat: 47.491865, lng: 19.050269 },
                    { lat: 47.497717, lng: 19.046456 },
                    { lat: 47.505254, lng: 19.044161 }
                ],
                isInside: false
            },
            'Belv√°ros': {
                polygon: [
                    { lat: 47.492765, lng: 19.053449 },
                    { lat: 47.494664, lng: 19.060327 },
                    { lat: 47.491990, lng: 19.061735 },
                    { lat: 47.489962, lng: 19.062238 },
                    { lat: 47.486635, lng: 19.062418 },
                    { lat: 47.484643, lng: 19.058464 },
                    { lat: 47.489574, lng: 19.052048 },
                    { lat: 47.492889, lng: 19.049281 },
                    { lat: 47.493860, lng: 19.052686 }
                ],
                isInside: false
            },
            'Conti': {
                polygon: [
                    { lat: 47.504349, lng: 19.067239 },
                    { lat: 47.501800, lng: 19.069939 },
                    { lat: 47.503799, lng: 19.073626 },
                    { lat: 47.503075, lng: 19.074569 },
                    { lat: 47.498615, lng: 19.073754 },
                    { lat: 47.493633, lng: 19.077012 },
                    { lat: 47.492301, lng: 19.070495 },
                    { lat: 47.492040, lng: 19.060766 },
                    { lat: 47.495487, lng: 19.058537 },
                    { lat: 47.497949, lng: 19.054250 },
                    { lat: 47.501829, lng: 19.061152 }
                ],
                isInside: false
            },
            'Budai': {
                polygon: [
                    { lat: 47.517476, lng: 19.040136 },
                    { lat: 47.512301, lng: 19.040825 },
                    { lat: 47.501449, lng: 19.041084 },
                    { lat: 47.496714, lng: 19.043184 },
                    { lat: 47.489582, lng: 19.048970 },
                    { lat: 47.485264, lng: 19.054092 },
                    { lat: 47.484386, lng: 19.052588 },
                    { lat: 47.487757, lng: 19.048762 },
                    { lat: 47.491265, lng: 19.042955 },
                    { lat: 47.493435, lng: 19.037831 },
                    { lat: 47.496528, lng: 19.032161 },
                    { lat: 47.501190, lng: 19.023484 },
                    { lat: 47.504882, lng: 19.023689 },
                    { lat: 47.508021, lng: 19.021229 },
                    { lat: 47.508159, lng: 19.025670 },
                    { lat: 47.510513, lng: 19.029359 },
                    { lat: 47.512128, lng: 19.034074 },
                    { lat: 47.516511, lng: 19.036055 },
                    { lat: 47.517527, lng: 19.036123 }
                ],
                isInside: false
            },
            'Crowne': {
                polygon: [
                    { lat: 47.526947, lng: 19.054402 },
                    { lat: 47.524934, lng: 19.063909 },
                    { lat: 47.517542, lng: 19.074701 },
                    { lat: 47.505532, lng: 19.055738 },
                    { lat: 47.504976, lng: 19.047721 },
                    { lat: 47.509246, lng: 19.044072 },
                    { lat: 47.517785, lng: 19.047875 }
                ],
                isInside: false
            },
            'Kozmo': {
                polygon: [
                    { lat: 47.493255, lng: 19.067396 },
                    { lat: 47.494823, lng: 19.077291 },
                    { lat: 47.489935, lng: 19.080590 },
                    { lat: 47.490581, lng: 19.090439 },
                    { lat: 47.486707, lng: 19.092372 },
                    { lat: 47.484232, lng: 19.075017 },
                    { lat: 47.486569, lng: 19.074971 },
                    { lat: 47.486615, lng: 19.067396 }
                ],
                isInside: false
            },
            'Rept√©r': {
                polygon: [
                    { lat: 47.419958, lng: 19.244589 },
                    { lat: 47.417475, lng: 19.251907 },
                    { lat: 47.418049, lng: 19.255322 },
                    { lat: 47.415881, lng: 19.261834 },
                    { lat: 47.412867, lng: 19.259522 },
                    { lat: 47.415307, lng: 19.251631 },
                    { lat: 47.415508, lng: 19.246541 },
                    { lat: 47.417676, lng: 19.243253 }
                ],
                isInside: false
            }
        };

        onAuthStateChanged(auth, async (user) => {
            try {
                if (user) {
                    const profileRef = doc(db, "profiles", user.uid);
                    const profileSnap = await getDoc(profileRef);

                    if (profileSnap.exists()) {
                        currentUserProfile = { uid: user.uid, ...profileSnap.data() };

                        preAuthView.classList.add('hidden');
                        dashboardContainer.classList.add('hidden');

                        // Pending st√°tusz ellen≈ërz√©s
                        if (currentUserProfile.status === 'pending') {
                            preAuthView.classList.remove('hidden');
                            authContainer.classList.add('hidden');
                            mainHeader.classList.add('hidden');
                            pendingApprovalContainer.classList.remove('hidden');
                        }
                        // Approved st√°tusz
                        else if (currentUserProfile.status === 'approved') {
                            dashboardContainer.classList.remove('hidden');
                            welcomeMessage.textContent = `Szia, ${currentUserProfile.username}!`;
                            initializeDashboard();
                            listenForDispatches();
                        } else {
                            await signOut(auth);
                        }
                    } else {
                        await signOut(auth);
                    }
                } else {
                    preAuthView.classList.remove('hidden');
                    dashboardContainer.classList.add('hidden');
                    authContainer.classList.remove('hidden');
                    mainHeader.classList.remove('hidden');
                    pendingApprovalContainer.classList.add('hidden');

                    welcomeMessage.textContent = '';
                    currentUserProfile = null;
                    lastCheckedOut = null;
                    if (unsubscribeLocationListener) unsubscribeLocationListener();
                    if (unsubscribeMapListener) unsubscribeMapListener();
                    if (unsubscribeDispatchListener) unsubscribeDispatchListener();
                    if (locationWatcherId) {
                        navigator.geolocation.clearWatch(locationWatcherId);
                        locationWatcherId = null;
                    }
                    hideDispatchPopup();
                }
            } catch (error) {
                console.error("Kritikus hiba az autentik√°ci√≥ sor√°n:", error);
                errorMessage.textContent = 'Hiba t√∂rt√©nt a bejelentkez√©s feldolgoz√°sakor.';
            }
        });

        loginTabButton.addEventListener('click', () => switchAuthForm('login'));
        registerTabButton.addEventListener('click', () => switchAuthForm('register'));
        forgotPasswordBtn.addEventListener('click', () => switchAuthForm('reset'));
        backToLoginBtn.addEventListener('click', () => switchAuthForm('login'));
        sendResetBtn.addEventListener('click', handlePasswordReset);
        registerForm.addEventListener('submit', (e) => handleAuth(e, 'register'));
        loginForm.addEventListener('submit', (e) => handleAuth(e, 'login'));
        logoutButton.addEventListener('click', handleLogout);
        pendingLogoutButton.addEventListener('click', handleLogout);

        // Jelsz√≥ l√°that√≥s√°g v√°lt√°s - Login
        const toggleLoginPassword = document.getElementById('toggle-login-password');
        const loginPasswordInput = document.getElementById('login-password');
        const eyeIconLogin = document.getElementById('eye-icon-login');
        const eyeSlashIconLogin = document.getElementById('eye-slash-icon-login');

        if (toggleLoginPassword) {
            toggleLoginPassword.addEventListener('click', () => {
                const type = loginPasswordInput.type === 'password' ? 'text' : 'password';
                loginPasswordInput.type = type;
                eyeIconLogin.classList.toggle('hidden');
                eyeSlashIconLogin.classList.toggle('hidden');
            });
        }

        // Jelsz√≥ l√°that√≥s√°g v√°lt√°s - Register
        const toggleRegisterPassword = document.getElementById('toggle-register-password');
        const registerPasswordInput = document.getElementById('register-password');
        const eyeIconRegister = document.getElementById('eye-icon-register');
        const eyeSlashIconRegister = document.getElementById('eye-slash-icon-register');

        if (toggleRegisterPassword) {
            toggleRegisterPassword.addEventListener('click', () => {
                const type = registerPasswordInput.type === 'password' ? 'text' : 'password';
                registerPasswordInput.type = type;
                eyeIconRegister.classList.toggle('hidden');
                eyeSlashIconRegister.classList.toggle('hidden');
            });
        }

        // Email verification gombok
        const resendVerificationBtn = document.getElementById('resend-verification-button');
        const verificationLogoutBtn = document.getElementById('verification-logout-button');

        if (resendVerificationBtn) {
            resendVerificationBtn.addEventListener('click', async () => {
                try {
                    const user = auth.currentUser;
                    if (user) {
                        await sendEmailVerification(user);
                        alert('‚úÖ Email √∫jrak√ºldve! Ellen≈ërizd a postal√°d√°d.');
                    }
                } catch (error) {
                    console.error("Hiba az email √∫jrak√ºld√©sekor:", error);
                    alert('Hiba t√∂rt√©nt az email k√ºld√©sekor. Pr√≥b√°ld √∫jra k√©s≈ëbb.');
                }
            });
        }

        if (verificationLogoutBtn) {
            verificationLogoutBtn.addEventListener('click', handleLogout);
        }

        function listenForDispatches() {
            if (unsubscribeDispatchListener) unsubscribeDispatchListener();
            if (!currentUserProfile) return;

            const dispatchRef = doc(db, "dispatches", currentUserProfile.uid);
            unsubscribeDispatchListener = onSnapshot(dispatchRef, (docSnap) => {
                if (docSnap.exists()) {
                    showDispatchPopup(docSnap.data());
                } else {
                    hideDispatchPopup();
                }
            });
        }

        function showDispatchPopup(data) {
            hideDispatchPopup();

            const popupHTML = `
            <div id="dispatch-popup-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-40 flex items-center justify-center p-4">
                <div id="dispatch-popup-content" class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-95 opacity-0 animate-fade-in-up">
                    <h2 class="text-xl font-bold text-indigo-600 dark:text-indigo-400 mb-4 border-b dark:border-gray-600 pb-3">√öj C√≠mkioszt√°s</h2>
                    <div class="space-y-4 text-sm">
                        <div>
                            <label class="font-semibold text-gray-600 dark:text-gray-400">Ki√°ll√°si hely:</label>
                            <p class="text-gray-900 dark:text-gray-100 mt-1">${data.address || 'N/A'}</p>
                        </div>
                        <div>
                            <label class="font-semibold text-gray-600 dark:text-gray-400">Ter√ºlet / T√≠pus:</label>
                            <p class="text-gray-900 dark:text-gray-100 mt-1">${data.locationType || 'N/A'} - ${data.vehicleType || 'N/A'}</p>
                        </div>
                        <div>
                            <label class="font-semibold text-gray-600 dark:text-gray-400">Kieg√©sz√≠t≈ë inform√°ci√≥:</label>
                            <p class="text-gray-900 dark:text-gray-100 mt-1 whitespace-pre-wrap break-words">${data.details || '-'}</p>
                        </div>
                    </div>
                    <div class="mt-6 text-right">
                        <button id="dispatch-end-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-300 dark:focus:ring-red-800 transition">
                            V√©ge
                        </button>
                    </div>
                </div>
            </div>
            <style>
                @keyframes fade-in-up {
                    from { transform: scale(0.95) translateY(10px); opacity: 0; }
                    to { transform: scale(1) translateY(0); opacity: 1; }
                }
                .animate-fade-in-up { animation: fade-in-up 0.3s ease-out forwards; }
            </style>
        `;
            dispatchPopupContainer.innerHTML = popupHTML;

            document.getElementById('dispatch-end-btn').addEventListener('click', async () => {
                if (!currentUserProfile) return;
                const dispatchRef = doc(db, "dispatches", currentUserProfile.uid);
                try {
                    await deleteDoc(dispatchRef);
                } catch (error) {
                    console.error("Hiba a c√≠mkioszt√°s t√∂rl√©sekor:", error);
                    hideDispatchPopup();
                }
            });
        }

        function hideDispatchPopup() {
            dispatchPopupContainer.innerHTML = '';
        }

        function renderDispatchPanel() {
            tabContent.innerHTML = `
            <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 sm:p-6 h-full flex flex-col">
                <h3 class="text-lg font-bold mb-4 border-b border-gray-300 dark:border-gray-700 pb-2 flex-shrink-0">
                    ${LOCATION_TITLES['C√≠mkioszt√≥']}
                </h3>
                <div class="flex-grow overflow-y-auto pr-2">
                    <form id="dispatch-form" class="space-y-5">
                        <div>
                            <label for="dispatch-address" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">C√≠m</label>
                            <input type="text" id="dispatch-address" required class="w-full px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition" placeholder="Pl. Budapest, F≈ë utca 1.">
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="dispatch-location-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">V√°ros / Rept√©r</label>
                                <select id="dispatch-location-type" required class="w-full px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition">
                                    <option value="V√°ros">V√°ros</option>
                                    <option value="Rept√©r">Rept√©r</option>
                                </select>
                            </div>
                            <div>
                                <label for="dispatch-vehicle-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">T√≠pus</label>
                                <select id="dispatch-vehicle-type" required class="w-full px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition">
                                    <option value="Taxi">Taxi</option>
                                    <option value="VIP">VIP</option>
                                    <option value="V-Oszt√°ly">V-Oszt√°ly</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label for="dispatch-details" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Kieg√©sz√≠t≈ë inform√°ci√≥k</label>
                            <textarea id="dispatch-details" rows="4" class="w-full px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition" placeholder="Pl. N√©vt√°bl√°val v√°rja, sok csomag, stb..."></textarea>
                        </div>

                        <div class="flex flex-col sm:flex-row items-center justify-between gap-4 pt-3 border-t dark:border-gray-600">
                            <div class="w-full sm:w-auto">
                                 <label for="dispatch-driver-id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sof≈ër sz√°ma</label>
                                 <input type="text" id="dispatch-driver-id" required maxlength="3" pattern="\\d{3}" title="A sof≈ër sz√°m√°nak pontosan 3 sz√°mb√≥l kell √°llnia." class="w-full sm:w-32 px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition" placeholder="000">
                            </div>
                            <button type="submit" class="w-full sm:w-auto bg-indigo-600 text-white font-bold py-2 px-8 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 dark:focus:ring-indigo-800 transition-transform transform hover:scale-105">
                                K√ºld√©s
                            </button>
                        </div>
                        <div id="dispatch-status-message" class="text-center text-sm font-semibold mt-2 h-4"></div>
                    </form>
                </div>
            </div>
        `;

            document.getElementById('dispatch-form').addEventListener('submit', handleDispatchSend);
        }

        async function handleDispatchSend(e) {
            e.preventDefault();
            const statusMessageEl = document.getElementById('dispatch-status-message');
            statusMessageEl.textContent = '';

            const driverUsername = document.getElementById('dispatch-driver-id').value;

            const profilesRef = collection(db, "profiles");
            const q = query(profilesRef, where("username", "==", driverUsername));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                statusMessageEl.textContent = 'Sof≈ër nem tal√°lhat√≥.';
                statusMessageEl.className = 'text-center text-sm font-semibold mt-2 h-4 text-red-500';
                return;
            }
            const driverUid = querySnapshot.docs[0].id;

            const dispatchData = {
                address: document.getElementById('dispatch-address').value,
                locationType: document.getElementById('dispatch-location-type').value,
                vehicleType: document.getElementById('dispatch-vehicle-type').value,
                details: document.getElementById('dispatch-details').value,
                timestamp: serverTimestamp()
            };

            try {
                const dispatchRef = doc(db, "dispatches", driverUid);
                await setDoc(dispatchRef, dispatchData);

                statusMessageEl.textContent = `C√≠m sikeresen kik√ºldve a(z) ${driverUsername} sof≈ërnek!`;
                statusMessageEl.className = 'text-center text-sm font-semibold mt-2 h-4 text-green-500';

                setTimeout(() => { statusMessageEl.textContent = ''; }, 4000);

            } catch (error) {
                console.error("Hiba a c√≠mkioszt√°s ment√©sekor:", error);
                statusMessageEl.textContent = 'Hiba t√∂rt√©nt a k√ºld√©s sor√°n.';
                statusMessageEl.className = 'text-center text-sm font-semibold mt-2 h-4 text-red-500';
            }
        }

        function getSubTabClasses(tabIdentifier, activeIdentifier) {
            const baseClasses = 'flex-1 py-3 px-4 text-center font-medium transition-all duration-200 rounded-t-lg cursor-pointer';
            const activeClasses = 'bg-black text-white dark:bg-white dark:text-black';
            const inactiveClasses = 'bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600';

            return `${baseClasses} ${activeIdentifier === tabIdentifier ? activeClasses : inactiveClasses}`;
        }

        function isPointInPolygon(point, polygon) {
            const x = point.lat;
            const y = point.lng;
            let isInside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i].lat, yi = polygon[i].lng;
                const xj = polygon[j].lat, yj = polygon[j].lng;
                const intersect = ((yi > y) !== (yj > y))
                    && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) isInside = !isInside;
            }
            return isInside;
        }

        async function updateDriverLocation(coords) {
            if (!currentUserProfile) return;
            const locationRef = doc(db, "driver_locations", currentUserProfile.uid);
            try {
                await setDoc(locationRef, {
                    lat: coords.latitude,
                    lng: coords.longitude,
                    timestamp: serverTimestamp()
                }, { merge: true });
            } catch (e) {
                console.error("Hiba a poz√≠ci√≥ friss√≠t√©sekor:", e);
            }
        }

        function startLocationWatcher() {
            if (locationWatcherId) {
                navigator.geolocation.clearWatch(locationWatcherId);
            }
            if ('geolocation' in navigator) {
                // AZONNAL lek√©rj√ºk a poz√≠ci√≥t √©s ellen≈ërizz√ºk
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const userPoint = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        console.log('üìç Jelenlegi poz√≠ci√≥ ellen≈ërz√©se oldal bet√∂lt√©skor...');

                        // ‚úÖ Friss√≠tj√ºk a driver location-t AZONNAL (await haszn√°lat√°val)
                        await updateDriverLocation(position.coords);

                        // Ellen≈ërizz√ºk MINDEN geo-fence z√≥n√°t
                        for (const locationName in geofencedLocations) {
                            if (geofencedLocations.hasOwnProperty(locationName)) {
                                const zone = geofencedLocations[locationName];
                                const isNowInside = isPointInPolygon(userPoint, zone.polygon);

                                // Ha K√çV√úL van, de bent van a sorban ‚Üí automatikus checkout
                                if (!isNowInside) {
                                    const locationRef = doc(db, "locations", locationName);
                                    try {
                                        const docSnap = await getDoc(locationRef);
                                        if (docSnap.exists() && currentUserProfile) {
                                            const data = docSnap.data();
                                            const members = data.members || [];

                                            if (members.some(m => m.uid === currentUserProfile.uid)) {
                                                console.log(`‚ö†Ô∏è AUTOMATIKUS KIL√âPTET√âS: User k√≠v√ºl van a(z) '${locationName}' z√≥n√°n, de bent volt a sorban!`);
                                                await checkOut(locationName);
                                            }

                                            // Emirates sor ellen≈ërz√©s
                                            if (locationName === 'Rept√©r') {
                                                const emiratesMembers = data.emiratesMembers || [];
                                                if (emiratesMembers.some(m => m.uid === currentUserProfile.uid)) {
                                                    console.log(`‚ö†Ô∏è AUTOMATIKUS KIL√âPTET√âS: User k√≠v√ºl van a rept√©ri z√≥n√°n, de bent volt az Emirates sorban!`);
                                                    await checkOutEmirates();
                                                }
                                            }
                                        }
                                    } catch (e) {
                                        console.error(`Hiba a ${locationName} ellen≈ërz√©sekor:`, e);
                                    }
                                }

                                // Friss√≠tj√ºk a z√≥na st√°tuszt
                                zone.isInside = isNowInside;
                            }
                        }

                        console.log('‚úÖ Geo-fence ellen≈ërz√©s befejezve');
                    },
                    (error) => {
                        console.error("Hiba az azonnali GPS poz√≠ci√≥ lek√©r√©sekor:", error.message);
                    }
                );

                // EZUT√ÅN indul a folyamatos watchPosition
                locationWatcherId = navigator.geolocation.watchPosition(
                    (position) => {
                        const userPoint = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        const now = Date.now();
                        if (now - lastLocationUpdateTime > 3000) {
                            lastLocationUpdateTime = now;
                            // ‚úÖ Error handling hozz√°ad√°sa
                            updateDriverLocation(position.coords).catch(e => console.error("Driver location update error:", e));
                        }

                        for (const locationName in geofencedLocations) {
                            if (geofencedLocations.hasOwnProperty(locationName)) {
                                const zone = geofencedLocations[locationName];
                                const wasInside = zone.isInside;
                                const isNowInside = isPointInPolygon(userPoint, zone.polygon);

                                if (wasInside !== isNowInside) {
                                    console.log(`Helyzet v√°ltoz√°s a(z) '${locationName}' z√≥n√°ban: a felhaszn√°l√≥ most ${isNowInside ? 'bel√ºl' : 'k√≠v√ºl'} van.`);

                                    if (wasInside && !isNowInside) {
                                        const locationRef = doc(db, "locations", locationName);
                                        getDoc(locationRef).then(docSnap => {
                                            if (docSnap.exists() && currentUserProfile) {
                                                const data = docSnap.data();
                                                const members = data.members || [];

                                                if (members.some(m => m.uid === currentUserProfile.uid)) {
                                                    console.log(`Automatikus kil√©ptet√©s a(z) '${locationName}' sorb√≥l (z√≥na elhagy√°sa).`);
                                                    checkOut(locationName);
                                                }

                                                // Emirates sor automatikus kil√©ptet√©s
                                                if (locationName === 'Rept√©r') {
                                                    const emiratesMembers = data.emiratesMembers || [];
                                                    if (emiratesMembers.some(m => m.uid === currentUserProfile.uid)) {
                                                        console.log(`Automatikus kil√©ptet√©s az Emirates sorb√≥l (rept√©ri z√≥na elhagy√°sa).`);
                                                        checkOutEmirates();
                                                    }
                                                }
                                            }
                                        });
                                    }

                                    zone.isInside = isNowInside;
                                    if (activeTab === locationName) {
                                        if (locationName === 'Rept√©r') {
                                            listenToAirportLocation();
                                        } else {
                                            const locationRef = doc(db, "locations", locationName);
                                            getDoc(locationRef).then(docSnap => {
                                                const members = (docSnap.exists() && docSnap.data().members) ? docSnap.data().members : [];
                                                renderLocationContent(locationName, members);
                                            });
                                        }
                                    }
                                }
                            }
                        }
                    },
                    (error) => {
                        console.error("Hiba a GPS poz√≠ci√≥ lek√©r√©sekor:", error.message);
                        for (const locationName in geofencedLocations) {
                            geofencedLocations[locationName].isInside = false;
                        }
                        if (geofencedLocations.hasOwnProperty(activeTab)) {
                            if (activeTab === 'Rept√©r') {
                                listenToAirportLocation();
                            } else {
                                renderLocationContent(activeTab, []);
                            }
                        }
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                console.warn("A b√∂ng√©sz≈ë nem t√°mogatja a geolok√°ci√≥t.");
            }
        }

        function switchAuthForm(type) {
            loginForm.classList.toggle('hidden', type !== 'login');
            registerForm.classList.toggle('hidden', type !== 'register');
            passwordResetForm.classList.toggle('hidden', type !== 'reset');

            loginTabButton.classList.toggle('text-indigo-600', type === 'login');
            loginTabButton.classList.toggle('dark:text-indigo-400', type === 'login');
            loginTabButton.classList.toggle('border-indigo-600', type === 'login');
            loginTabButton.classList.toggle('dark:border-indigo-400', type === 'login');
            loginTabButton.classList.toggle('text-gray-500', type !== 'login');
            loginTabButton.classList.toggle('dark:text-gray-400', type !== 'login');

            registerTabButton.classList.toggle('text-indigo-600', type === 'register');
            registerTabButton.classList.toggle('dark:text-indigo-400', type === 'register');
            registerTabButton.classList.toggle('border-indigo-600', type === 'register');
            registerTabButton.classList.toggle('dark:border-indigo-400', type === 'register');
            registerTabButton.classList.toggle('text-gray-500', type !== 'register');
            registerTabButton.classList.toggle('dark:text-gray-400', type !== 'register');

            errorMessage.textContent = '';
        }

        async function handlePasswordReset() {
            const email = document.getElementById('reset-email').value;
            if (!email) {
                errorMessage.textContent = 'K√©rlek add meg az email c√≠med.';
                return;
            }

            try {
                await sendPasswordResetEmail(auth, email);
                errorMessage.textContent = '';
                alert('Jelsz√≥ vissza√°ll√≠t√≥ email elk√ºldve! Ellen≈ërizd a postal√°d√°d.');
                switchAuthForm('login');
            } catch (error) {
                console.error("Hiba a jelsz√≥ vissza√°ll√≠t√°s sor√°n:", error);
                if (error.code === 'auth/user-not-found') {
                    errorMessage.textContent = 'Nem tal√°lhat√≥ felhaszn√°l√≥ ezzel az email c√≠mmel.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage.textContent = '√ârv√©nytelen email c√≠m.';
                } else {
                    errorMessage.textContent = 'Hiba t√∂rt√©nt. Pr√≥b√°ld √∫jra k√©s≈ëbb.';
                }
            }
        }

        async function handleAuth(event, type) {
            event.preventDefault();
            errorMessage.textContent = '';

            try {
                if (type === 'register') {
                    const email = document.getElementById('register-email').value.trim();
                    const callsign = document.getElementById('register-callsign').value.trim();
                    const password = document.getElementById('register-password').value;
                    let licensePlate = document.getElementById('register-license-plate').value.toUpperCase().replace(/\s/g, '');
                    const userType = document.getElementById('register-type').value;

                    // H√≠v√≥sz√°m valid√°ci√≥
                    if (!/^\d{3}$/.test(callsign)) {
                        errorMessage.textContent = 'A h√≠v√≥sz√°mnak pontosan 3 sz√°mb√≥l kell √°llnia.';
                        return;
                    }

                    // Rendsz√°m valid√°ci√≥
                    const licensePlateRegex = /^[a-zA-Z0-9]{6,7}$/;
                    if (!licensePlateRegex.test(licensePlate)) {
                        errorMessage.textContent = '√ârv√©nytelen rendsz√°m form√°tum. Helyes form√°tumok: ABC123 vagy ABCD123.';
                        return;
                    }

                    // Ellen≈ërizz√ºk, hogy a h√≠v√≥sz√°m m√°r l√©tezik-e
                    const profilesRef = collection(db, "profiles");
                    const callsignQuery = query(profilesRef, where("username", "==", callsign));
                    const existingCallsigns = await getDocs(callsignQuery);

                    if (!existingCallsigns.empty) {
                        errorMessage.textContent = 'Ez a h√≠v√≥sz√°m m√°r foglalt. V√°lassz m√°sikat.';
                        return;
                    }

                    // Ellen≈ërizz√ºk van-e m√°r felhaszn√°l√≥
                    const snapshot = await getDocs(profilesRef);
                    const isFirstUser = snapshot.empty;

                    // Firebase Auth regisztr√°ci√≥
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    // Firestore profil l√©trehoz√°sa
                    const profileRef = doc(db, "profiles", user.uid);

                    // VIP vagy VIP Kombi eset√©n automatikusan l√°that√≥ a 213-as
                    const canSee213Auto = (userType === 'VIP' || userType === 'VIP Kombi');

                    await setDoc(profileRef, {
                        email: email,
                        username: callsign,
                        licensePlate: licensePlate,
                        userType: userType,
                        status: isFirstUser ? 'approved' : 'pending',
                        role: isFirstUser ? 'admin' : 'user',
                        canSee213: canSee213Auto
                    });

                    // Sikeres regisztr√°ci√≥ - nincs alert, csak a pending k√©perny≈ë jelenik meg
                    // Az onAuthStateChanged automatikusan mutatja a pending approval √ºzenetet

                } else {
                    // Login
                    const email = document.getElementById('login-email').value.trim();
                    const password = document.getElementById('login-password').value;

                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                console.error("Hiba t√∂rt√©nt:", error);
                errorMessage.textContent = mapAuthCodeToMessage(error.code);
            }
        }

        async function handleLogout() {
            try {
                if (currentUserProfile && currentUserProfile.status === 'approved') {
                    await checkoutFromAllLocations().catch(e => console.error("Hiba a kijelentkez√©skor a helyekr≈ël:", e));

                    if (currentUserProfile.uid) {
                        const driverLocationRef = doc(db, "driver_locations", currentUserProfile.uid);
                        await deleteDoc(driverLocationRef).catch(e => console.log("Driver location m√°r t√∂r√∂lve vagy nem l√©tezik"));
                    }
                }
                await signOut(auth);
            } catch (error) {
                console.error("Kijelentkez√©si hiba:", error);
            }
        }

        function initializeDashboard() {
            navUl.innerHTML = '';
            startLocationWatcher();

            let displayTabs = [...TABS];

            if (currentUserProfile.userType === 'V-Oszt√°ly' || currentUserProfile.role === 'admin') {
                displayTabs.push('V-Oszt√°ly');
            }

            if (currentUserProfile.role === 'admin' || currentUserProfile.canSee213 === true) {
                displayTabs.push('213');
            }

            if (currentUserProfile.role === 'admin') {
                displayTabs.push('T√©rk√©p');
                displayTabs.push('Admin');
                displayTabs.push('C√≠mkioszt√≥');
            }

            displayTabs.push('Profil');

            displayTabs.forEach((tabName, index) => {
                const li = document.createElement('li');
                li.className = 'mr-2 whitespace-nowrap';
                const a = document.createElement('a');
                a.href = '#';
                a.textContent = tabName;
                a.className = 'inline-block py-2 px-4 rounded-md transition-colors duration-300 text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700';

                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    setActiveTab(a, tabName);
                });

                li.appendChild(a);
                navUl.appendChild(li);
                if (index === 0) setActiveTab(a, tabName);
            });
        }

        function setActiveTab(activeLink, tabName) {
            if (unsubscribeLocationListener) {
                unsubscribeLocationListener();
                unsubscribeLocationListener = null;
            }
            if (unsubscribeMapListener) {
                unsubscribeMapListener();
                unsubscribeMapListener = null;
            }

            activeTab = tabName;
            navUl.querySelectorAll('a').forEach(link => {
                link.classList.remove('bg-gray-900', 'text-white', 'dark:bg-gray-200', 'dark:text-black', 'font-semibold');
                link.classList.add('text-gray-500', 'hover:bg-gray-100', 'dark:text-gray-400', 'dark:hover:bg-gray-700');
            });
            activeLink.classList.remove('text-gray-500', 'hover:bg-gray-100', 'dark:text-gray-400', 'dark:hover:bg-gray-700');
            activeLink.classList.add('bg-gray-900', 'text-white', 'dark:bg-gray-200', 'dark:text-black', 'font-semibold');

            if (tabName === 'Admin') {
                renderAdminPanel();
            } else if (tabName === 'C√≠mkioszt√≥') {
                renderDispatchPanel();
            } else if (tabName === 'T√©rk√©p') {
                renderMapPage();
            } else if (tabName === 'V-Oszt√°ly') {
                listenToVClassLocation();
            } else if (tabName === 'Rept√©r') {
                listenToAirportLocation();
            } else if (tabName === '213') {
                listenTo213Location();
            } else if (tabName === 'Profil') {
                renderProfileTab();
            } else {
                listenToLocation(tabName);
            }
        }

        function renderMapPage() {
            tabContent.innerHTML = `
            <div id="map-container" class="h-full w-full relative">
                <div id="map" class="h-full w-full rounded-lg"></div>
                <div id="map-search-box" class="absolute top-3 right-3 z-[1000] bg-white p-1.5 rounded-lg shadow-lg flex items-center">
                    <input type="text" id="map-search-input" placeholder="Sof≈ër sz√°ma..." class="px-2 py-1 border rounded-l-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-black">
                    <button id="map-search-btn" class="bg-indigo-600 text-white px-3 py-1 rounded-r-md hover:bg-indigo-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>`;

            const MAPTILER_API_KEY = 'lc2h4XBIrkWU2FS5JXD9';

            const map = L.map('map').setView([47.4979, 19.0402], 12);

            L.tileLayer(`https://api.maptiler.com/maps/streets-v2/{z}/{x}/{y}.png?key=${MAPTILER_API_KEY}`, {
                attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',
            }).addTo(map);

            const driverMarkers = {};
            const driverProfiles = {};

            const handleSearch = () => {
                const searchTerm = document.getElementById('map-search-input').value.trim();
                if (!searchTerm) return;

                let foundDriverId = null;
                for (const uid in driverProfiles) {
                    if (driverProfiles[uid].username === searchTerm) {
                        foundDriverId = uid;
                        break;
                    }
                }

                if (foundDriverId && driverMarkers[foundDriverId]) {
                    const marker = driverMarkers[foundDriverId];
                    const latLng = marker.getLatLng();
                    map.flyTo(latLng, 16);
                    marker.openPopup();
                } else {
                    alert('Sof≈ër nem tal√°lhat√≥.');
                }
            };

            document.getElementById('map-search-btn').addEventListener('click', handleSearch);
            document.getElementById('map-search-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    handleSearch();
                }
            });

            const locationsRef = collection(db, "driver_locations");
            unsubscribeMapListener = onSnapshot(locationsRef, async (snapshot) => {
                const changes = snapshot.docChanges();

                for (const change of changes) {
                    const driverId = change.doc.id;
                    const locationData = change.doc.data();

                    if (change.type === "added" || change.type === "modified") {
                        // Mindig friss√≠tj√ºk a profilt, ha m√©g nincs cache-elve
                        if (!driverProfiles[driverId]) {
                            try {
                                const profileSnap = await getDoc(doc(db, "profiles", driverId));
                                if (profileSnap.exists()) {
                                    driverProfiles[driverId] = profileSnap.data();
                                } else {
                                    // Ha nincs profil, placeholder
                                    driverProfiles[driverId] = { username: '?', licensePlate: 'N/A' };
                                }
                            } catch (error) {
                                console.error(`Hiba a profil bet√∂lt√©sekor (${driverId}):`, error);
                                driverProfiles[driverId] = { username: '?', licensePlate: 'Hiba' };
                            }
                        }

                        const profile = driverProfiles[driverId];
                        const popupContent = `<b>H√≠v√≥jel:</b> ${profile.username}<br><b>Rendsz√°m:</b> ${profile.licensePlate || 'N/A'}`;

                        const customIcon = L.divIcon({
                            html: `<div class="driver-marker">${profile.username}</div>`,
                            className: '',
                            iconSize: [32, 32],
                            iconAnchor: [16, 16]
                        });

                        if (driverMarkers[driverId]) {
                            driverMarkers[driverId].setLatLng([locationData.lat, locationData.lng]);
                            driverMarkers[driverId].getPopup().setContent(popupContent);
                            driverMarkers[driverId].setIcon(customIcon);
                        } else {
                            driverMarkers[driverId] = L.marker([locationData.lat, locationData.lng], { icon: customIcon }).addTo(map)
                                .bindPopup(popupContent);
                        }
                    } else if (change.type === "removed") {
                        if (driverMarkers[driverId]) {
                            map.removeLayer(driverMarkers[driverId]);
                            delete driverMarkers[driverId];
                            delete driverProfiles[driverId];
                        }
                    }
                }
            });
        }

        function listenToLocation(locationName) {
            if (unsubscribeLocationListener) unsubscribeLocationListener();
            const locationRef = doc(db, "locations", locationName);
            unsubscribeLocationListener = onSnapshot(locationRef, (docSnap) => {
                const members = (docSnap.exists() && docSnap.data().members) ? docSnap.data().members : [];
                renderLocationContent(locationName, members);
            });
        }

        function listenToVClassLocation() {
            if (unsubscribeLocationListener) unsubscribeLocationListener();
            const locationRef = doc(db, "locations", "V-Oszt√°ly");
            unsubscribeLocationListener = onSnapshot(locationRef, (docSnap) => {
                if (docSnap.exists()) {
                    vClassMembers = docSnap.data().members || [];
                    vClassNotes = docSnap.data().notes || [''];
                    renderVClassContent();
                } else {
                    vClassMembers = [];
                    vClassNotes = [''];
                    renderVClassContent();
                }
            });
        }

        function listenToAirportLocation() {
            if (unsubscribeLocationListener) unsubscribeLocationListener();

            // Listen to Rept√©r
            const airportRef = doc(db, "locations", "Rept√©r");
            unsubscribeLocationListener = onSnapshot(airportRef, (docSnap) => {
                if (docSnap.exists()) {
                    airportMembers = docSnap.data().members || [];
                    airportNotes = docSnap.data().notes || [''];
                } else {
                    airportMembers = [];
                    airportNotes = [''];
                }
                renderAirportContent();
            });

            // Listen to Emirates independently
            const emiratesRef = doc(db, "locations", "Emirates");
            onSnapshot(emiratesRef, (docSnap) => {
                if (docSnap.exists()) {
                    emiratesMembers = docSnap.data().members || [];
                } else {
                    emiratesMembers = [];
                }
                renderAirportContent(); // Refresh UI when Emirates changes
            });
        }

        function listenTo213Location() {
            if (unsubscribeLocationListener) unsubscribeLocationListener();
            const locationRef = doc(db, "locations", "213");
            unsubscribeLocationListener = onSnapshot(locationRef, (docSnap) => {
                if (docSnap.exists()) {
                    p213Notes = docSnap.data().notes || [''];
                    render213Content();
                } else {
                    p213Notes = [''];
                    render213Content();
                }
            });
        }

        function renderProfileTab() {
            if (!currentUserProfile) return;

            tabContent.innerHTML = `
            <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                <h4 class="font-bold text-lg mb-4 border-b border-gray-300 dark:border-gray-600 pb-2">Profil</h4>

                <div class="space-y-4">
                    <div class="flex flex-col gap-1">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Felhaszn√°l√≥n√©v</label>
                        <div class="px-3 py-2 bg-gray-100 dark:bg-gray-700 rounded-md">${currentUserProfile.username}</div>
                    </div>

                    <div class="flex flex-col gap-1">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email c√≠m</label>
                        <input
                            type="email"
                            value="${currentUserProfile.email || ''}"
                            readonly
                            class="w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg cursor-not-allowed opacity-75"
                        >
                        <p class="text-xs text-gray-500 mt-1">‚ÑπÔ∏è Az email c√≠m biztons√°gi okokb√≥l nem m√≥dos√≠that√≥</p>
                    </div>

                    <div class="flex flex-col gap-1">
                        <label for="license-plate-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Rendsz√°m</label>
                        <input
                            type="text"
                            id="license-plate-input"
                            value="${currentUserProfile.licensePlate || ''}"
                            class="w-full px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                            placeholder="ABC123 vagy ABCD123"
                        >
                        <p class="text-xs text-gray-500 mt-1">Form√°tum: ABC123 vagy ABCD123</p>
                    </div>

                    <div class="flex flex-col gap-1">
                        <label for="user-type-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300">T√≠pus</label>
                        <select id="user-type-select" class="w-full px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                            <option value="Taxi" ${currentUserProfile.userType === 'Taxi' ? 'selected' : ''}>Taxi</option>
                            <option value="Kombi Taxi" ${currentUserProfile.userType === 'Kombi Taxi' ? 'selected' : ''}>Kombi Taxi</option>
                            <option value="VIP" ${currentUserProfile.userType === 'VIP' ? 'selected' : ''}>VIP</option>
                            <option value="VIP Kombi" ${currentUserProfile.userType === 'VIP Kombi' ? 'selected' : ''}>VIP Kombi</option>
                            <option value="V-Oszt√°ly" ${currentUserProfile.userType === 'V-Oszt√°ly' ? 'selected' : ''}>V-Oszt√°ly</option>
                        </select>
                    </div>

                    <button id="save-profile-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                        Ment√©s
                    </button>
                </div>
            </div>
        `;

            document.getElementById('save-profile-btn').addEventListener('click', handleProfileUpdate);
        }

        async function handleProfileUpdate() {
            if (!currentUserProfile) return;

            const licensePlateInput = document.getElementById('license-plate-input');
            const userTypeSelect = document.getElementById('user-type-select');

            let newLicensePlate = licensePlateInput.value.toUpperCase().replace(/\s/g, '');
            const newUserType = userTypeSelect.value;

            const licensePlateRegex = /^[a-zA-Z0-9]{6,7}$/;
            if (!licensePlateRegex.test(newLicensePlate)) {
                alert('√ârv√©nytelen rendsz√°m form√°tum. Helyes form√°tumok: ABC123 vagy ABCD123.');
                return;
            }

            try {
                // VIP vagy VIP Kombi eset√©n automatikusan l√°that√≥ a 213-as
                const canSee213Auto = (newUserType === 'VIP' || newUserType === 'VIP Kombi');

                const profileRef = doc(db, "profiles", currentUserProfile.uid);
                await updateDoc(profileRef, {
                    licensePlate: newLicensePlate,
                    userType: newUserType,
                    canSee213: canSee213Auto
                });

                currentUserProfile.licensePlate = newLicensePlate;
                currentUserProfile.userType = newUserType;
                currentUserProfile.canSee213 = canSee213Auto;

                await checkoutFromAllLocations();
                await updateUserDisplayNameInAllLocations();
                initializeDashboard();

                setTimeout(() => {
                    const profileTabLink = [...navUl.querySelectorAll('a')].find(a => a.textContent === 'Profil');
                    if (profileTabLink) {
                        setActiveTab(profileTabLink, 'Profil');
                    }
                }, 0);

                alert('Profil sikeresen friss√≠tve!');
            } catch (error) {
                console.error("Hiba a profil friss√≠t√©sekor:", error);
                alert('Hiba t√∂rt√©nt a profil friss√≠t√©se sor√°n.');
            }
        }

        async function updateUserDisplayNameInAllLocations() {
            if (!currentUserProfile) return;

            const updatedUserObject = createMemberObject(currentUserProfile);
            if (!updatedUserObject) return;

            const batch = writeBatch(db);
            const allLocations = [...TABS, 'V-Oszt√°ly', 'Rept√©r'];

            for (const locationName of allLocations) {
                const locationRef = doc(db, "locations", locationName);
                const docSnap = await getDoc(locationRef);

                if (docSnap.exists()) {
                    let members = [];
                    let emiratesMembers = [];

                    if (locationName === 'Rept√©r') {
                        members = docSnap.data().members || [];
                        emiratesMembers = docSnap.data().emiratesMembers || [];

                        const updatedMembers = members.map(member =>
                            member.uid === currentUserProfile.uid ? updatedUserObject : member
                        );

                        const updatedEmirates = emiratesMembers.map(member =>
                            member.uid === currentUserProfile.uid ? updatedUserObject : member
                        );

                        if (JSON.stringify(members) !== JSON.stringify(updatedMembers) ||
                            JSON.stringify(emiratesMembers) !== JSON.stringify(updatedEmirates)) {
                            batch.update(locationRef, {
                                members: updatedMembers,
                                emiratesMembers: updatedEmirates
                            });
                        }
                    }
                    else {
                        members = docSnap.data().members || [];
                        const updatedMembers = members.map(member =>
                            member.uid === currentUserProfile.uid ? updatedUserObject : member
                        );

                        if (JSON.stringify(members) !== JSON.stringify(updatedMembers)) {
                            batch.update(locationRef, { members: updatedMembers });
                        }
                    }
                }
            }

            try {
                await batch.commit();
                console.log("Felhaszn√°l√≥ adatai sikeresen friss√≠tve minden helysz√≠nen.");
            } catch (error) {
                console.error("Hiba a felhaszn√°l√≥ adatainak friss√≠t√©sekor:", error);
            }
        }

        function renderLocationContent(locationName, members) {
            if (!currentUserProfile) return;
            const isCurrentUserCheckedIn = members.some(member => member.uid === currentUserProfile.uid);
            const canUndo = lastCheckedOut && lastCheckedOut.memberData.uid === currentUserProfile.uid && lastCheckedOut.locationName === locationName;
            const listTitle = LOCATION_TITLES[locationName] || `${locationName} Sor`;

            let isGeoBlocked = false;
            let titleSuffix = '';

            if (geofencedLocations.hasOwnProperty(locationName)) {
                const isInside = geofencedLocations[locationName].isInside;
                if (!isInside) {
                    isGeoBlocked = true;
                    titleSuffix = `
                    <span class="inline-block align-middle ml-2" title="Z√≥n√°n k√≠v√ºl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                        </svg>
                    </span>`;
                } else {
                    titleSuffix = `
                    <span class="inline-block align-middle ml-2" title="Z√≥n√°n bel√ºl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20">
                            <rect width="20" height="20" rx="3" fill="#22c55e" />
                            <path fill-rule="evenodd" d="M9.47 5.22a.75.75 0 011.06 0l4.25 4.25a.75.75 0 01-1.06 1.06L10 6.81l-3.72 3.72a.75.75 0 01-1.06-1.06l4.25-4.25z" clip-rule="evenodd" fill="white" />
                        </svg>
                    </span>`;
                }
            }

            tabContent.innerHTML = `
            <div class="location-content-wrapper flex flex-row gap-4 h-full">
                <div class="flex-1 bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 overflow-y-auto">
                    <h4 class="font-bold text-lg mb-3 border-b border-gray-300 dark:border-gray-600 pb-2 sticky top-0 bg-gray-50 dark:bg-gray-700/50 -mt-4 -mx-4 px-4 pt-4">${listTitle} (${members.length}) ${titleSuffix}</h4>
                    <div id="member-list" class="space-y-2">
                       ${members.length > 0 ? members.map(m => {
                let displayName = m.displayName;
                const isFlame = displayName.includes('__FLAME__');
                displayName = displayName.replace('__FLAME__', '').trim();
                const itemClasses = isFlame
                    ? "member-item bg-rose-100 dark:bg-red-900/50 border-2 border-rose-500 p-2 rounded-md text-sm flex justify-between items-center"
                    : "member-item bg-white dark:bg-gray-800 p-2 rounded-md shadow-sm text-sm flex justify-between items-center";

                return `
                                <div class="${itemClasses}" data-uid="${m.uid}" data-user-type="${m.userType}" data-member-json='${JSON.stringify(m)}'>
                                    <span class="text-base font-bold">${displayName}${m.checkInTime ? ' - ' + m.checkInTime : ''}</span>
                                    ${currentUserProfile.role === 'admin' ? `
                                        <button class="kick-btn text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-100 dark:hover:bg-red-900" data-uid="${m.uid}" data-user-type="${m.userType}">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    ` : ''}
                                </div>
                            `;
            }).join('') : '<p class="text-sm text-gray-500">Nincs itt senki.</p>'}
                    </div>
                </div>
                <div class="action-buttons-container">
                    <button id="check-in-btn" class="bg-green-600 text-white font-semibold hover:bg-green-700 transition" ${isCurrentUserCheckedIn || isGeoBlocked ? 'disabled' : ''}>Be</button>
                    <button id="check-out-btn" class="bg-orange-500 text-white font-semibold hover:bg-orange-600 transition" ${!isCurrentUserCheckedIn ? 'disabled' : ''}>Ki</button>
                    <button id="flame-btn" class="bg-red-600 text-white font-semibold hover:bg-red-700 transition" ${!canUndo || isCurrentUserCheckedIn || isGeoBlocked ? 'disabled' : ''}>üî•</button>
                    <button id="food-phone-btn" class="bg-blue-500 text-white font-semibold hover:bg-blue-600 transition" ${!isCurrentUserCheckedIn || isGeoBlocked ? 'disabled' : ''}>üçîüìû</button>
                </div>
            </div>
         `;

            tabContent.removeEventListener('click', handleActionButtons);
            tabContent.addEventListener('click', handleActionButtons);

            if (currentUserProfile.role === 'admin') {
                initSortableList(locationName);
            }
        }

        function render213Content() {
            const isAdmin = currentUserProfile.role === 'admin';
            const listTitle = '213';

            tabContent.innerHTML = `
            <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 flex flex-col h-full">
                <div class="flex justify-between items-center mb-3 border-b border-gray-300 dark:border-gray-600 pb-2">
                    <h4 class="font-bold text-lg">${listTitle}</h4>
                    ${isAdmin ? `
                        <button id="add-note-btn" class="add-note-btn px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    ` : ''}
                </div>
                <div id="orders-container" class="flex-grow overflow-y-auto">
                    <div id="notes-list" class="space-y-2">
                        ${p213Notes.map((note, index) => `
                            <div class="note-item flex flex-col mb-3" data-index="${index}">
                                <div class="flex">
                                    ${isAdmin ? `
                                        <span class="drag-handle">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                <path d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" />
                                            </svg>
                                        </span>
                                    ` : ''}
                                    <input type="text" ${isAdmin ? '' : 'readonly'}
                                        class="note-input w-full px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                        value="${note}"
                                        placeholder="Rendel√©s...">
                                    <button class="delete-note-btn px-3 bg-red-500 text-white rounded-r-lg hover:bg-red-600 transition ${(typeof note === 'string' ? note.trim() : String(note || '').trim()) === '' ? 'opacity-50 cursor-not-allowed' : ''}" 
                                        data-index="${index}" 
                                        title="Rendel√©s t√∂rl√©se"
                                        ${(typeof note === 'string' ? note.trim() : String(note || '').trim()) === '' ? 'disabled' : ''}>
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;

            setup213Handlers();

            if (isAdmin) {
                initSortableNotes('213');
            }
        }

        function setup213Handlers() {
            const container = document.getElementById('tab-content');
            if (!container) return;

            // T√°vol√≠tsuk el az √ñSSZES r√©gi listenert
            const old213ClickHandler = container._p213ClickHandler;
            const old213KeydownHandler = container._p213KeydownHandler;
            const old213BlurHandler = container._p213BlurHandler;

            if (old213ClickHandler) {
                container.removeEventListener('click', old213ClickHandler);
            }
            if (old213KeydownHandler) {
                container.removeEventListener('keydown', old213KeydownHandler);
            }
            if (old213BlurHandler) {
                container.removeEventListener('blur', old213BlurHandler, true);
            }

            // √öj handlerek - EGYSZER
            const clickHandler = (e) => {
                if (activeTab !== '213') return;

                if (e.target.closest('#add-note-btn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    update213NotesInFirestore(null, null, false, true);
                    return;
                }

                const deleteBtn = e.target.closest('.delete-note-btn');
                if (deleteBtn && !deleteBtn.disabled) {
                    e.preventDefault();
                    e.stopPropagation();

                    const index = parseInt(deleteBtn.dataset.index);

                    if (confirm('Biztosan t√∂rli a rendel√©st?')) {
                        update213NotesInFirestore(index, null, true).catch(error => {
                            alert('Hiba t√∂rt√©nt a t√∂rl√©s sor√°n: ' + error.message);
                        });
                    }
                }
            };

            const keydownHandler = (e) => {
                if (activeTab !== '213') return;
                if (e.target.classList.contains('note-input') && e.key === 'Enter') {
                    e.preventDefault();
                    e.target.blur();
                }
            };

            const blurHandler = (e) => {
                if (activeTab !== '213') return;
                if (e.target.classList.contains('note-input')) {
                    const input = e.target;
                    const index = parseInt(input.closest('.note-item').dataset.index);
                    const newValue = input.value.trim();
                    update213NotesInFirestore(index, newValue, false);
                }
            };

            container.addEventListener('click', clickHandler);
            container.addEventListener('keydown', keydownHandler);
            container.addEventListener('blur', blurHandler, true);

            // T√°roljuk
            container._p213ClickHandler = clickHandler;
            container._p213KeydownHandler = keydownHandler;
            container._p213BlurHandler = blurHandler;
        }

        async function handle213Click(e) {
            // Ez a f√ºggv√©ny m√°r NEM haszn√°lt
        }

        async function handle213Keydown(e) {
            // Ez a f√ºggv√©ny m√°r NEM haszn√°lt
        }

        async function handle213Blur(e) {
            // Ez a f√ºggv√©ny m√°r NEM haszn√°lt
        }

        async function update213NotesInFirestore(index, newValue = null, isDelete = false, isAdd = false) {
            // ‚úÖ 213-as rendel√©sek t√∂rl√©s√©hez nem kell admin jog
            if (isDelete) {
                // T√∂rl√©s enged√©lyezve mindenki sz√°m√°ra
            } else if (currentUserProfile.role !== 'admin') {
                // Hozz√°ad√°s √©s m√≥dos√≠t√°s csak adminoknak
                return;
            }

            const locationRef = doc(db, "locations", "213");

            try {
                const docSnap = await getDoc(locationRef);
                let notes = [...p213Notes];

                if (isDelete) {
                    if (notes.length === 1) {
                        notes = [''];
                    } else {
                        notes.splice(index, 1);
                    }
                } else if (isAdd) {
                    notes.unshift('');
                } else if (newValue !== null) {
                    if (index >= 0 && index < notes.length) {
                        notes[index] = newValue;
                    }
                }

                if (notes.length === 0) {
                    await setDoc(locationRef, { notes: [''] }, { merge: true });
                } else {
                    await setDoc(locationRef, { notes }, { merge: true });
                }
            } catch (error) {
                console.error('Firestore hiba:', error);
                throw error;
            }
        }

        function renderAirportContent() {
            const isAdmin = currentUserProfile.role === 'admin';
            const isCurrentUserCheckedIn = airportMembers.some(m => m.uid === currentUserProfile.uid);
            const isCurrentUserInEmirates = emiratesMembers.some(m => m.uid === currentUserProfile.uid);
            const canUndoAirport = lastCheckedOut && lastCheckedOut.memberData.uid === currentUserProfile.uid && lastCheckedOut.locationName === 'Rept√©r' && lastCheckedOut.memberType === 'members';
            const canUndoEmirates = lastCheckedOut && lastCheckedOut.memberData.uid === currentUserProfile.uid && lastCheckedOut.locationName === 'Rept√©r' && lastCheckedOut.memberType === 'emiratesMembers';

            // ‚úÖ Emirates sor geofencing ellen≈ërz√©s
            let isAirportGeoBlocked = false;
            let isEmiratesGeoBlocked = false;
            let airportTitleSuffix = '';
            let emiratesTitleSuffix = '';

            // Rept√©r geofence check
            if (geofencedLocations.hasOwnProperty('Rept√©r')) {
                const isInside = geofencedLocations['Rept√©r'].isInside;
                if (!isInside) {
                    isAirportGeoBlocked = true;
                    airportTitleSuffix = `
                    <span class="inline-block align-middle ml-2" title="Z√≥n√°n k√≠v√ºl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                        </svg>
                    </span>`;
                } else {
                    airportTitleSuffix = `
                    <span class="inline-block align-middle ml-2" title="Z√≥n√°n bel√ºl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20">
                            <rect width="20" height="20" rx="3" fill="#22c55e" />
                            <path fill-rule="evenodd" d="M9.47 5.22a.75.75 0 011.06 0l4.25 4.25a.75.75 0 01-1.06 1.06L10 6.81l-3.72 3.72a.75.75 0 01-1.06-1.06l4.25-4.25z" clip-rule="evenodd" fill="white" />
                        </svg>
                    </span>`;
                }
            }

            // Emirates geofence check (Reper geofence applies to Emirates too by rule, but checking standalone just in case)
            // But usually Emirates is strictly inside Rept√©r. The logic "isEmiratesGeoBlocked = true" was used if Rept√©r is blocked.
            if (isAirportGeoBlocked) {
                isEmiratesGeoBlocked = true;
                emiratesTitleSuffix = airportTitleSuffix;
            } else {
                emiratesTitleSuffix = `
                    <span class="inline-block align-middle ml-2" title="Z√≥n√°n bel√ºl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20">
                            <rect width="20" height="20" rx="3" fill="#22c55e" />
                            <path fill-rule="evenodd" d="M9.47 5.22a.75.75 0 011.06 0l4.25 4.25a.75.75 0 01-1.06 1.06L10 6.81l-3.72 3.72a.75.75 0 01-1.06-1.06l4.25-4.25z" clip-rule="evenodd" fill="white" />
                        </svg>
                    </span>`;
            }

            tabContent.innerHTML = `
            <div class="flex flex-col gap-4 h-full">
                <div class="flex gap-2 mb-2">
                    <button id="airport-tab" class="${getSubTabClasses('airport', airportActiveSubTab)}">
                        Rept√©r
                    </button>
                    <button id="orders-tab" class="${getSubTabClasses('orders', airportActiveSubTab)}">
                        Rendel√©sek
                    </button>
                    <button id="emirates-tab" class="${getSubTabClasses('emirates', airportActiveSubTab)}">
                        Emirates
                    </button>
                </div>

                <div id="airport-subtab-content" class="flex-1 flex flex-col min-h-0">
                    ${airportActiveSubTab === 'airport' ? `
                        <div class="location-content-wrapper flex flex-row gap-4 h-full">
                            <div class="flex-1 bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 overflow-y-auto">
                                <h4 class="font-bold text-lg mb-3 border-b border-gray-300 dark:border-gray-600 pb-2 sticky top-0 bg-gray-50 dark:bg-gray-700/50 -mt-4 -mx-4 px-4 pt-4">Rept√©ri Sor (${airportMembers.length}) ${airportTitleSuffix}</h4>
                                <div id="member-list" class="space-y-2">
                                   ${airportMembers.length > 0 ? airportMembers.filter(m => m && m.uid).map(m => {
                let displayName = m.displayName || 'Ismeretlen';
                const isFlame = displayName.includes('__FLAME__');
                displayName = displayName.replace('__FLAME__', '').trim();
                const itemClasses = isFlame
                    ? "member-item bg-rose-100 dark:bg-red-900/50 border-2 border-rose-500 p-2 rounded-md text-sm flex justify-between items-center"
                    : "member-item bg-white dark:bg-gray-800 p-2 rounded-md shadow-sm text-sm flex justify-between items-center";

                return `
                                            <div class="${itemClasses}" data-uid="${m.uid}" data-user-type="${m.userType}" data-member-json='${JSON.stringify(m)}'>
                                                <span class="text-base font-bold">${displayName}${m.checkInTime ? ' - ' + m.checkInTime : ''}</span>
                                                ${isAdmin ? `
                                                    <button class="kick-btn text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-100 dark:hover:bg-red-900" data-uid="${m.uid}" data-user-type="${m.userType}">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                        </svg>
                                                    </button>
                                                ` : ''}
                                            </div>
                                        `;
            }).join('') : '<p class="text-sm text-gray-500">Nincs itt senki.</p>'}
                                </div>
                            </div>
                            <div class="action-buttons-container">
                                <button id="check-in-btn" class="bg-green-600 text-white font-semibold hover:bg-green-700 transition" ${isCurrentUserCheckedIn || isAirportGeoBlocked ? 'disabled' : ''}>Be</button>
                                <button id="check-out-btn" class="bg-orange-500 text-white font-semibold hover:bg-orange-600 transition" ${!isCurrentUserCheckedIn ? 'disabled' : ''}>Ki</button>
                                <button id="flame-btn" class="bg-red-600 text-white font-semibold hover:bg-red-700 transition" ${!canUndoAirport || isCurrentUserCheckedIn || isAirportGeoBlocked ? 'disabled' : ''}>üî•</button>
                                <button id="food-phone-btn" class="bg-blue-500 text-white font-semibold hover:bg-blue-600 transition" ${!isCurrentUserCheckedIn || isAirportGeoBlocked ? 'disabled' : ''}>üçîüìû</button>
                            </div>
                        </div>
                    ` : ''}
                    ${airportActiveSubTab === 'orders' ? `
                        <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 flex flex-col h-full">
                            <div class="flex justify-between items-center mb-3 border-b border-gray-300 dark:border-gray-600 pb-2">
                                <h4 class="font-bold text-lg">Rept√©ri Sor</h4>
                                ${isAdmin ? `
                                    <button id="add-note-btn" class="add-note-btn px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                ` : ''}
                            </div>
                            <div id="orders-container" class="flex-grow overflow-y-auto">
                                <div id="notes-list" class="space-y-2">
                                    ${airportNotes.map((note, index) => `
                                        <div class="note-item flex flex-col mb-3" data-index="${index}">
                                            <div class="flex">
                                                ${isAdmin ? `
                                                    <span class="drag-handle">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                            <path d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" />
                                                        </svg>
                                                    </span>
                                                ` : ''}
                                                <input type="text" ${isAdmin ? '' : 'readonly'}
                                                    class="note-input w-full px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                                    value="${note}"
                                                    placeholder="Rendel√©s...">
                                                <button class="delete-note-btn px-3 bg-red-500 text-white rounded-r-lg hover:bg-red-600 transition ${(typeof note === 'string' ? note.trim() : String(note || '').trim()) === '' ? 'opacity-50 cursor-not-allowed' : ''}" 
                                                    data-index="${index}" 
                                                    title="Rendel√©s t√∂rl√©se"
                                                    ${(typeof note === 'string' ? note.trim() : String(note || '').trim()) === '' ? 'disabled' : ''}>
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    ${airportActiveSubTab === 'emirates' ? `
                        <div class="location-content-wrapper flex flex-row gap-4 h-full">
                            <div class="flex-1 bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 overflow-y-auto">
                                <h4 class="font-bold text-lg mb-3 border-b border-gray-300 dark:border-gray-600 pb-2 sticky top-0 bg-gray-50 dark:bg-gray-700/50 -mt-4 -mx-4 px-4 pt-4">Emirates Sor (${emiratesMembers.length}) ${emiratesTitleSuffix}</h4>
                                <div id="member-list" class="space-y-2">
                                   ${emiratesMembers.length > 0 ? emiratesMembers.filter(m => m && m.uid).map(m => {
                let displayName = m.displayName || 'Ismeretlen';
                const isFlame = displayName.includes('__FLAME__');
                displayName = displayName.replace('__FLAME__', '').trim();
                const itemClasses = isFlame
                    ? "member-item bg-rose-100 dark:bg-red-900/50 border-2 border-rose-500 p-2 rounded-md text-sm flex justify-between items-center"
                    : "member-item bg-white dark:bg-gray-800 p-2 rounded-md shadow-sm text-sm flex justify-between items-center";

                return `
                                            <div class="${itemClasses}" data-uid="${m.uid}" data-user-type="${m.userType}" data-member-json='${JSON.stringify(m)}'>
                                                <span class="text-base font-bold">${displayName}${m.checkInTime ? ' - ' + m.checkInTime : ''}</span>
                                                ${isAdmin ? `
                                                    <button class="kick-btn text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-100 dark:hover:bg-red-900" data-uid="${m.uid}" data-user-type="${m.userType}">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                        </svg>
                                                    </button>
                                                ` : ''}
                                            </div>
                                        `;
            }).join('') : '<p class="text-sm text-gray-500">Nincs itt senki.</p>'}
                                </div>
                            </div>
                            <div class="action-buttons-container">
                                <button id="emirates-check-in-btn" class="bg-green-600 text-white font-semibold hover:bg-green-700 transition" ${isCurrentUserInEmirates || isEmiratesGeoBlocked ? 'disabled' : ''}>Be</button>
                                <button id="emirates-check-out-btn" class="bg-orange-500 text-white font-semibold hover:bg-orange-600 transition" ${!isCurrentUserInEmirates ? 'disabled' : ''}>Ki</button>
                                <button id="emirates-flame-btn" class="bg-red-600 text-white font-semibold hover:bg-red-700 transition" ${!canUndoEmirates || isCurrentUserInEmirates || isEmiratesGeoBlocked ? 'disabled' : ''}>üî•</button>
                                <button id="emirates-food-phone-btn" class="bg-blue-500 text-white font-semibold hover:bg-blue-600 transition" ${!isCurrentUserInEmirates || isEmiratesGeoBlocked ? 'disabled' : ''}>üçîüìû</button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
         `;

            document.getElementById('airport-tab').addEventListener('click', () => {
                airportActiveSubTab = 'airport';
                renderAirportContent();
            });

            document.getElementById('orders-tab').addEventListener('click', () => {
                airportActiveSubTab = 'orders';
                renderAirportContent();
            });

            document.getElementById('emirates-tab').addEventListener('click', () => {
                airportActiveSubTab = 'emirates';
                renderAirportContent();
            });

            if (isAdmin) {
                if (airportActiveSubTab === 'emirates') {
                    initSortableList('Emirates', 'members');
                } else if (airportActiveSubTab === 'airport') {
                    initSortableList('Rept√©r', 'members');
                } else if (airportActiveSubTab === 'orders') {
                    if (isAdmin) {
                        initSortableNotes('Rept√©r');
                    }
                    setupNotesHandlers('Rept√©r');
                }
            } else if (airportActiveSubTab === 'orders') {
                // ‚úÖ Nem-adminok sz√°m√°ra is be√°ll√≠tjuk a handlereket
                setupNotesHandlers('Rept√©r');
            }

            tabContent.removeEventListener('click', handleActionButtons);
            tabContent.addEventListener('click', handleActionButtons);
        }

        function renderVClassContent() {
            const isAdmin = currentUserProfile.role === 'admin';

            tabContent.innerHTML = `
            <div class="flex flex-col gap-4 h-full">
                <div class="flex gap-2 mb-2">
                    <button id="v-class-members-tab" class="${getSubTabClasses('members', vClassActiveSubTab)}">
                        V-Oszt√°ly Sor
                    </button>
                    <button id="v-class-orders-tab" class="${getSubTabClasses('orders', vClassActiveSubTab)}">
                        Rendel√©sek
                    </button>
                </div>

                <div id="v-class-subtab-content" class="flex-1 flex flex-col min-h-0">
                    ${vClassActiveSubTab === 'members' ? renderVClassMembersTab() : renderOrdersTab()}
                </div>
            </div>
         `;

            document.getElementById('v-class-members-tab').addEventListener('click', () => {
                vClassActiveSubTab = 'members';
                renderVClassContent();
            });

            document.getElementById('v-class-orders-tab').addEventListener('click', () => {
                vClassActiveSubTab = 'orders';
                renderVClassContent();
            });

            if (isAdmin) {
                if (vClassActiveSubTab === 'members') {
                    initSortableList('V-Oszt√°ly');
                } else if (vClassActiveSubTab === 'orders') {
                    initSortableNotes('V-Oszt√°ly');
                    setupNotesHandlers('V-Oszt√°ly');
                }
            } else if (vClassActiveSubTab === 'orders') {
                // ‚úÖ Nem-adminok sz√°m√°ra is be√°ll√≠tjuk a handlereket
                setupNotesHandlers('V-Oszt√°ly');
            }
        }

        function renderOrdersTab() {
            const isAdmin = currentUserProfile.role === 'admin';
            return `
            <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 flex flex-col h-full">
                <div class="flex justify-between items-center mb-3 border-b border-gray-300 dark:border-gray-600 pb-2">
                    <h4 class="font-bold text-lg">V-Oszt√°ly Sor</h4>
                    ${isAdmin ? `
                        <button id="add-note-btn" class="add-note-btn px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    ` : ''}
                </div>
                <div id="orders-container" class="orders-container flex-grow">
                    <div id="notes-list" class="space-y-2">
                        ${vClassNotes.map((note, index) => `
                            <div class="note-item flex flex-col mb-3" data-index="${index}">
                                <div class="flex">
                                    ${isAdmin ? `
                                        <span class="drag-handle">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                <path d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" />
                                            </svg>
                                        </span>
                                    ` : ''}
                                    <input type="text" ${isAdmin ? '' : 'readonly'}
                                        class="note-input w-full px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                                        value="${note}"
                                        placeholder="Rendel√©s...">
                                    <button class="delete-note-btn px-3 bg-red-500 text-white rounded-r-lg hover:bg-red-600 transition ${(typeof note === 'string' ? note.trim() : String(note || '').trim()) === '' ? 'opacity-50 cursor-not-allowed' : ''}" 
                                        data-index="${index}" 
                                        title="Rendel√©s t√∂rl√©se"
                                        ${(typeof note === 'string' ? note.trim() : String(note || '').trim()) === '' ? 'disabled' : ''}>
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
        }

        function renderVClassMembersTab() {
            const isAdmin = currentUserProfile.role === 'admin';
            const listTitle = LOCATION_TITLES['V-Oszt√°ly'] || 'V-Oszt√°ly Sor';

            return `
            <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 h-full flex flex-col">
                <h4 class="font-bold text-lg mb-3 border-b border-gray-300 dark:border-gray-600 pb-2">${listTitle} (${vClassMembers.length})</h4>
                <div id="member-list" class="space-y-2 overflow-y-auto flex-grow">
                   ${vClassMembers.length > 0 ? vClassMembers.map(m => {
                let displayName = m.displayName;
                const isFlame = displayName.includes('__FLAME__');
                displayName = displayName.replace('__FLAME__', '').trim();
                const itemClasses = isFlame
                    ? "member-item bg-rose-100 dark:bg-red-900/50 border-2 border-rose-500 p-2 rounded-md text-sm flex justify-between items-center"
                    : "member-item bg-white dark:bg-gray-800 p-2 rounded-md shadow-sm text-sm flex justify-between items-center";

                return `
                            <div class="${itemClasses}" data-uid="${m.uid}" data-user-type="${m.userType}">
                                <span class="text-base font-bold">${displayName}</span>
                                ${isAdmin ? `
                                    <button class="kick-btn text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-100 dark:hover:bg-red-900" data-uid="${m.uid}" data-user-type="${m.userType}">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                ` : ''}
                            </div>
                        `;
            }).join('') : '<p class="text-sm text-gray-500">Nincs itt senki.</p>'}
                </div>
            </div>
        `;
        }

        function setupNotesHandlers(locationName = 'V-Oszt√°ly') {
            const tab = document.getElementById('tab-content');
            if (!tab) return;

            // T√°vol√≠tsuk el az √ñSSZES r√©gi event listenert
            const oldClickHandler = tab._notesClickHandler;
            const oldKeydownHandler = tab._notesKeydownHandler;
            const oldBlurHandler = tab._notesBlurHandler;

            if (oldClickHandler) {
                tab.removeEventListener('click', oldClickHandler);
            }
            if (oldKeydownHandler) {
                tab.removeEventListener('keydown', oldKeydownHandler);
            }
            if (oldBlurHandler) {
                tab.removeEventListener('blur', oldBlurHandler, true);
            }

            // √öj handlerek - EGYSZER h√≠vjuk csak
            const clickHandler = (e) => {
                // Csak akkor dolgozzunk ha a megfelel≈ë f√ºl√∂n vagyunk
                const isCorrectTab = (activeTab === locationName) ||
                    (activeTab === 'Rept√©r' && locationName === 'Rept√©r' && airportActiveSubTab === 'orders') ||
                    (activeTab === 'V-Oszt√°ly' && locationName === 'V-Oszt√°ly' && vClassActiveSubTab === 'orders');

                if (!isCorrectTab) return;

                const deleteBtn = e.target.closest('.delete-note-btn');
                if (deleteBtn && !deleteBtn.disabled) {
                    e.preventDefault();
                    e.stopPropagation();

                    const index = parseInt(deleteBtn.dataset.index);

                    if (confirm('Biztosan t√∂rli a rendel√©st?')) {
                        updateNotesInFirestore(index, null, true, locationName).catch(error => {
                            alert('Hiba t√∂rt√©nt a t√∂rl√©s sor√°n: ' + error.message);
                        });
                    }
                    return;
                }

                if (e.target.closest('#add-note-btn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    updateNotesInFirestore(null, null, false, locationName, true);
                    return;
                }
            };

            const keydownHandler = (e) => {
                if (e.target.classList.contains('note-input') && e.key === 'Enter') {
                    e.preventDefault();
                    e.target.blur();
                }
            };

            const blurHandler = (e) => {
                const isCorrectTab = (activeTab === locationName) ||
                    (activeTab === 'Rept√©r' && locationName === 'Rept√©r' && airportActiveSubTab === 'orders') ||
                    (activeTab === 'V-Oszt√°ly' && locationName === 'V-Oszt√°ly' && vClassActiveSubTab === 'orders');

                if (!isCorrectTab) return;

                if (e.target.classList.contains('note-input')) {
                    const input = e.target;
                    const index = parseInt(input.closest('.note-item').dataset.index);
                    const newValue = input.value.trim();
                    updateNotesInFirestore(index, newValue, false, locationName);
                }
            };

            tab.addEventListener('click', clickHandler);
            tab.addEventListener('keydown', keydownHandler);
            tab.addEventListener('blur', blurHandler, true);

            // T√°roljuk a handlereket
            tab._notesClickHandler = clickHandler;
            tab._notesKeydownHandler = keydownHandler;
            tab._notesBlurHandler = blurHandler;
        }

        async function handleNotesClick(e, locationName) {
            // Ellen≈ërizz√ºk hogy a megfelel≈ë f√ºl√∂n vagyunk-e
            const isCorrectTab = (activeTab === locationName) ||
                (activeTab === 'Rept√©r' && locationName === 'Rept√©r' && airportActiveSubTab === 'orders') ||
                (activeTab === 'V-Oszt√°ly' && locationName === 'V-Oszt√°ly' && vClassActiveSubTab === 'orders');

            if (!isCorrectTab) {
                return;
            }

            // Ha a t√∂rl√©s gombra kattintottak
            const deleteBtn = e.target.closest('.delete-note-btn');
            if (deleteBtn) {
                // ‚úÖ Ellen≈ërizz√ºk hogy disabled-e
                if (deleteBtn.disabled) {
                    return; // Ne csin√°ljunk semmit ha disabled
                }

                e.preventDefault();
                e.stopPropagation();

                const index = parseInt(deleteBtn.dataset.index);

                // ‚úÖ Nat√≠v confirm - csak egyszer kell kattintani
                if (confirm('Biztosan t√∂rli a rendel√©st?')) {
                    try {
                        await updateNotesInFirestore(index, null, true, locationName);
                    } catch (error) {
                        alert('Hiba t√∂rt√©nt a t√∂rl√©s sor√°n: ' + error.message);
                    }
                }
                return;
            }

            // Ha a hozz√°ad√°s gombra kattintottak (csak admin)
            if (e.target.closest('#add-note-btn')) {
                e.preventDefault();
                e.stopPropagation();
                await updateNotesInFirestore(null, null, false, locationName, true);
                return;
            }
        }

        // Meger≈ës√≠t≈ë dial√≥gus f√ºggv√©ny
        function showConfirmDialog(message) {
            return new Promise((resolve) => {
                const dialogHTML = `
                <div id="confirm-dialog-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
                    <div id="confirm-dialog-content" class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm p-6">
                        <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100 mb-4">${message}</h3>
                        <div class="flex gap-3 justify-end">
                            <button id="confirm-cancel" class="px-6 py-2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 font-bold rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition">
                                M√©gsem
                            </button>
                            <button id="confirm-yes" class="px-6 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition">
                                Igen
                            </button>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideUp {
                        from { transform: scale(0.95) translateY(20px); opacity: 0; }
                        to { transform: scale(1) translateY(0); opacity: 1; }
                    }
                    #confirm-dialog-overlay {
                        animation: fadeIn 0.2s ease-out;
                    }
                    #confirm-dialog-content {
                        animation: slideUp 0.3s ease-out;
                    }
                </style>
            `;

                const container = document.createElement('div');
                container.innerHTML = dialogHTML;
                document.body.appendChild(container);

                const overlay = document.getElementById('confirm-dialog-overlay');
                const yesBtn = document.getElementById('confirm-yes');
                const cancelBtn = document.getElementById('confirm-cancel');

                const cleanup = () => {
                    if (container.parentNode) {
                        document.body.removeChild(container);
                    }
                };

                yesBtn.addEventListener('click', () => {
                    cleanup();
                    resolve(true);
                });

                cancelBtn.addEventListener('click', () => {
                    cleanup();
                    resolve(false);
                });

                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        cleanup();
                        resolve(false);
                    }
                });
            });
        }

        async function handleNotesKeydown(e) {
            if (e.target.classList.contains('note-input') && e.key === 'Enter') {
                e.preventDefault();
                e.target.blur();
            }
        }

        async function handleNotesBlur(e, locationName) {
            if (activeTab !== locationName && !(activeTab === 'Rept√©r' && locationName === 'Rept√©r' && airportActiveSubTab === 'orders')) return;
            if (e.target.classList.contains('note-input')) {
                const input = e.target;
                const index = parseInt(input.closest('.note-item').dataset.index);
                const newValue = input.value.trim();
                await updateNotesInFirestore(index, newValue, false, locationName);
            }
        }

        async function updateNotesInFirestore(index, newValue = null, isDelete = false, locationName = 'V-Oszt√°ly', isAdd = false) {
            // ‚úÖ Rept√©r √©s V-Oszt√°ly rendel√©sek t√∂rl√©s√©hez nem kell admin jog
            if ((locationName === 'Rept√©r' || locationName === 'V-Oszt√°ly') && isDelete) {
                // T√∂rl√©s enged√©lyezve mindenki sz√°m√°ra
            } else if (locationName !== 'Rept√©r' && locationName !== 'V-Oszt√°ly' && currentUserProfile.role !== 'admin') {
                // M√°s helyeken csak admin
                return;
            } else if ((locationName === 'Rept√©r' || locationName === 'V-Oszt√°ly') && !isDelete && currentUserProfile.role !== 'admin') {
                // Rept√©r √©s V-Oszt√°lyn√°l csak t√∂rl√©s enged√©lyezett nem-adminoknak
                return;
            }

            const locationRef = doc(db, "locations", locationName);

            try {
                const docSnap = await getDoc(locationRef);
                let notes = [];

                if (docSnap.exists()) {
                    notes = [...(docSnap.data().notes || [''])];
                }

                if (isDelete) {
                    if (notes.length === 1) {
                        notes = [''];
                    } else {
                        notes.splice(index, 1);
                    }
                } else if (isAdd) {
                    if (locationName === 'Rept√©r' || locationName === 'V-Oszt√°ly') {
                        notes.unshift('');
                    } else {
                        notes.push('');
                    }
                } else if (newValue !== null) {
                    if (index >= 0 && index < notes.length) {
                        notes[index] = newValue;
                    }
                }

                if (notes.length === 0) {
                    await setDoc(locationRef, { notes: [''] }, { merge: true });
                } else {
                    await updateDoc(locationRef, { notes });
                }
            } catch (error) {
                console.error('Firestore hiba:', error);
                throw error;
            }
        }

        function initSortableList(locationName, memberType = 'members') {
            if (sortableMembersInstance) {
                sortableMembersInstance.destroy();
                sortableMembersInstance = null;
            }

            const memberList = document.getElementById('member-list');
            if (!memberList) return;

            sortableMembersInstance = new Sortable(memberList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                onEnd: async function (evt) {
                    const updatedMembers = [];
                    const memberElements = memberList.querySelectorAll('.member-item');

                    memberElements.forEach(el => {
                        try {
                            const memberData = JSON.parse(el.dataset.memberJson);
                            updatedMembers.push(memberData);
                        } catch (e) {
                            console.error("Hiba a member data parse-ol√°sakor:", e);
                            // Fallback ha s√©r√ºlt a JSON (de elvileg nem szabadna)
                            const uid = el.dataset.uid;
                            const displayName = el.querySelector('span').textContent.trim();
                            updatedMembers.push({
                                uid: uid,
                                displayName: displayName,
                                // Itt sajnos elvesznek adatok ha a JSON parse nem siker√ºl, de legal√°bb nem omlik √∂ssze
                            });
                        }
                    });

                    try {
                        const locationRef = doc(db, "locations", locationName);
                        let updateData = {};

                        if (locationName === 'Rept√©r' && memberType === 'emirates') {
                            // Emirates is now a standalone docs, but dragInit sends two args.
                            // However, initSortableList is called with (locationName, memberType).
                            // If we want to sort Emirates, we need to handle it.
                            // Actually, let's fix the call site or handle it here.
                            const emiratesRef = doc(db, "locations", "Emirates");
                            await updateDoc(emiratesRef, { members: updatedMembers });
                        } else {
                            updateData.members = updatedMembers;
                            await updateDoc(locationRef, updateData);
                        }

                    } catch (error) {
                        console.error("Hiba a sorrend ment√©sekor:", error);
                    }
                }
            });
        }

        function initSortableNotes(locationName = 'V-Oszt√°ly') {
            if (sortableNotesInstance) {
                sortableNotesInstance.destroy();
                sortableNotesInstance = null;
            }

            const notesList = document.getElementById('notes-list');
            if (!notesList) return;

            sortableNotesInstance = new Sortable(notesList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                handle: '.drag-handle',
                onEnd: async function (evt) {
                    const noteInputs = notesList.querySelectorAll('.note-input');
                    const updatedNotes = [];
                    noteInputs.forEach(input => {
                        updatedNotes.push(input.value);
                    });

                    try {
                        const locationRef = doc(db, "locations", locationName);
                        await updateDoc(locationRef, {
                            notes: updatedNotes
                        });
                    } catch (error) {
                        console.error("Hiba a jegyzetek sorrendj√©nek ment√©sekor:", error);
                    }
                }
            });
        }

        async function renderAdminPanel() {
            if (unsubscribeLocationListener) {
                unsubscribeLocationListener();
                unsubscribeLocationListener = null;
            }

            tabContent.innerHTML = `
            <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg h-full flex flex-col">
                <h3 class="text-lg font-bold p-4 border-b border-gray-300 dark:border-gray-700 flex-shrink-0">
                    Adminisztr√°ci√≥
                </h3>
                <div class="flex-grow overflow-y-auto p-4">
                    <div id="admin-user-list" class="space-y-2">
                        Bet√∂lt√©s...
                    </div>
                </div>
            </div>
        `;

            try {
                const usersRef = collection(db, "profiles");
                const q = query(usersRef);
                const querySnapshot = await getDocs(q);
                let users = [];

                querySnapshot.forEach((doc) => {
                    const user = { id: doc.id, ...doc.data() };
                    if (currentUserProfile && doc.id === currentUserProfile.uid) return;
                    users.push(user);
                });

                users.sort((a, b) => parseInt(a.username) - parseInt(b.username));

                let usersHtml = '';
                users.forEach(user => {
                    const statusColor = user.status === 'pending'
                        ? 'bg-yellow-100 dark:bg-yellow-800/40'
                        : 'bg-white dark:bg-gray-800';

                    // 213 st√°tusz meghat√°roz√°sa
                    const has213Access = user.canSee213 === true || user.role === 'admin';
                    const status213 = has213Access ? '‚úÖ' : '‚ùå';

                    usersHtml += `
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between p-3 rounded-md shadow-sm ${statusColor} min-w-0">
                        <div class="flex items-center min-w-0 flex-1">
                            <div class="bg-gray-200 dark:bg-gray-600 rounded-full w-8 h-8 flex items-center justify-center mr-3 flex-shrink-0">
                                <span class="text-sm font-bold">${user.username}</span>
                            </div>
                            <div class="truncate flex-1">
                                <p class="font-semibold text-sm truncate">${user.userType || 'N/A'} - ${user.licensePlate || 'N/A'}</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <p class="text-xs text-gray-600 dark:text-gray-400 truncate">${user.email || 'N/A'}</p>
                                    <button 
                                        class="copy-email-btn text-gray-500 hover:text-indigo-600 dark:hover:text-indigo-400 transition flex-shrink-0" 
                                        data-email="${user.email || ''}"
                                        title="Email m√°sol√°sa"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                        </svg>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 truncate mt-2">${user.status} | ${user.role} | 213: ${status213}</p>
                            </div>
                        </div>
                        <div class="flex flex-wrap items-center gap-2 mt-2 sm:mt-0 sm:ml-4 flex-shrink-0">
                            ${user.status !== 'approved' ? `
                                <button data-uid="${user.id}" class="approve-btn px-3 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600">J√≥v√°hagy</button>` : ''
                        }
                            ${user.status !== 'pending' ? `
                                <button data-uid="${user.id}" class="suspend-btn px-3 py-1 text-xs bg-yellow-500 text-white rounded hover:bg-yellow-600">Felf√ºggeszt</button>` : ''
                        }
                            ${user.role !== 'admin' ? `
                                <button data-uid="${user.id}" class="make-admin-btn px-3 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600">Admin</button>` : `
                                <button data-uid="${user.id}" class="remove-admin-btn px-3 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600">Admin elt√°vol√≠t√°s</button>`
                        }
                            <button data-uid="${user.id}" data-username="${user.username}" class="delete-user-btn p-2 text-xs bg-red-600 text-white rounded hover:bg-red-700 ml-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                });

                document.getElementById('admin-user-list').innerHTML = usersHtml || `
                <p class="text-gray-500 text-center py-4">Nincsenek m√°s felhaszn√°l√≥k</p>
            `;

                document.querySelectorAll('.approve-btn').forEach(button => {
                    button.addEventListener('click', () => updateUserStatus(button.dataset.uid, 'approved'));
                });

                document.querySelectorAll('.suspend-btn').forEach(button => {
                    button.addEventListener('click', () => updateUserStatus(button.dataset.uid, 'pending'));
                });

                document.querySelectorAll('.make-admin-btn').forEach(button => {
                    button.addEventListener('click', () => updateUserRole(button.dataset.uid, 'admin'));
                });

                document.querySelectorAll('.remove-admin-btn').forEach(button => {
                    button.addEventListener('click', () => updateUserRole(button.dataset.uid, 'user'));
                });

                document.querySelectorAll('.copy-email-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const email = button.dataset.email;
                        try {
                            await navigator.clipboard.writeText(email);
                            // Visual feedback
                            const originalHTML = button.innerHTML;
                            button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>';
                            button.classList.add('text-green-500');
                            setTimeout(() => {
                                button.innerHTML = originalHTML;
                                button.classList.remove('text-green-500');
                            }, 1500);
                        } catch (err) {
                            console.error('M√°sol√°si hiba:', err);
                            alert('Nem siker√ºlt m√°solni: ' + email);
                        }
                    });
                });

                document.querySelectorAll('.delete-user-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const uid = button.dataset.uid;
                        const username = button.dataset.username;
                        if (window.confirm(`Biztosan t√∂r√∂lni szeretn√©d a(z) ${username} felhaszn√°l√≥t? Ez a m≈±velet nem vonhat√≥ vissza!`)) {
                            handleDeleteUser(uid);
                        }
                    });
                });

            } catch (error) {
                console.error("Hiba az admin panel bet√∂lt√©sekor:", error);
                tabContent.innerHTML = `<div class="p-4 text-red-500">Hiba t√∂rt√©nt az adminisztr√°ci√≥s panel bet√∂lt√©sekor.</div>`;
            }
        }

        async function handleDeleteUser(uid) {
            if (!uid) return;
            console.log(`Felhaszn√°l√≥ t√∂rl√©s√©nek megkezd√©se: ${uid}`);

            // Meger≈ës√≠t≈ë dial√≥gus
            const confirmDelete = confirm('Biztosan t√∂r√∂lni szeretn√©d ezt a felhaszn√°l√≥t?\n\nEz a m≈±velet a k√∂vetkez≈ëket teszi:\n‚Ä¢ Firestore profil t√∂rl√©se\n‚Ä¢ √ñsszes helysz√≠nr≈ël elt√°vol√≠t√°s\n‚Ä¢ Driver location t√∂rl√©se\n‚Ä¢ Dispatch t√∂rl√©se\n\nA felhaszn√°l√≥ nem tud majd bejelentkezni.');

            if (!confirmDelete) {
                return;
            }

            try {
                // 1. T√°vol√≠tsuk el minden helysz√≠nr≈ël
                await removeUserFromAllLocations(uid);

                // 2. T√∂r√∂lj√ºk a driver_locations-b≈ël
                const driverLocationRef = doc(db, "driver_locations", uid);
                await deleteDoc(driverLocationRef).catch(e => {
                    console.log("Driver location nem l√©tezik vagy m√°r t√∂r√∂lve:", e.message);
                });

                // 3. T√∂r√∂lj√ºk a dispatches-b≈ël (ha van)
                const dispatchRef = doc(db, "dispatches", uid);
                await deleteDoc(dispatchRef).catch(e => {
                    console.log("Dispatch nem l√©tezik vagy m√°r t√∂r√∂lve:", e.message);
                });

                // 4. T√∂r√∂lj√ºk a profilt Firestore-b√≥l
                const profileRef = doc(db, "profiles", uid);
                await deleteDoc(profileRef);

                console.log(`A(z) ${uid} azonos√≠t√≥j√∫ felhaszn√°l√≥ sikeresen t√∂r√∂lve.`);

                // ‚úÖ FONTOS INFORM√ÅCI√ì:
                // A Firebase Authentication felhaszn√°l√≥ tov√°bbra is l√©tezik, DE:
                // - Nem tud bejelentkezni (nincs profil ‚Üí onAuthStateChanged kijelentkezteti)
                // - Nem f√©r hozz√° semmihez (Firestore Rules blokkolja)
                // - Gyakorlatilag "halott" account

                alert('‚úÖ Felhaszn√°l√≥ sikeresen t√∂r√∂lve!\n\nüóëÔ∏è T√∂rl√©sek:\n‚Ä¢ Firestore profil ‚úì\n‚Ä¢ Helysz√≠nekr≈ël elt√°vol√≠tva ‚úì\n‚Ä¢ Driver location ‚úì\n‚Ä¢ Dispatch ‚úì\n\n‚ö†Ô∏è Megjegyz√©s:\nA Firebase Auth account tov√°bbra is l√©tezik, de a felhaszn√°l√≥ nem tud bejelentkezni (profil hi√°nya miatt automatikusan ki lesz jelentkeztetve).\n\nTeljes t√∂rl√©shez sz√ºks√©ges: Firebase Admin SDK vagy Firebase Console.');

                // 5. Friss√≠ts√ºk az admin panelt
                await renderAdminPanel();

            } catch (error) {
                console.error("Hiba a felhaszn√°l√≥ t√∂rl√©sekor:", error);
                alert('‚ùå Hiba t√∂rt√©nt a t√∂rl√©s sor√°n:\n' + error.message);
            }
        }

        async function removeUserFromAllLocations(uid) {
            if (!uid) return;
            const batch = writeBatch(db);
            const allLocationNames = [...TABS, 'V-Oszt√°ly', 'Rept√©r'];

            try {
                for (const locName of allLocationNames) {
                    const locationRef = doc(db, "locations", locName);
                    const docSnap = await getDoc(locationRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        let needsUpdate = false;
                        const updateData = {};

                        if (data.members && data.members.some(m => m.uid === uid)) {
                            updateData.members = data.members.filter(m => m.uid !== uid);
                            needsUpdate = true;
                        }

                        if (locName === 'Rept√©r' && data.emiratesMembers && data.emiratesMembers.some(m => m.uid === uid)) {
                            updateData.emiratesMembers = data.emiratesMembers.filter(m => m.uid !== uid);
                            needsUpdate = true;
                        }

                        if (needsUpdate) {
                            batch.update(locationRef, updateData);
                        }
                    }
                }
                await batch.commit();
                console.log(`A(z) ${uid} azonos√≠t√≥j√∫ felhaszn√°l√≥ elt√°vol√≠tva minden helysz√≠nr≈ël.`);
            } catch (error) {
                console.error(`Hiba t√∂rt√©nt a(z) ${uid} felhaszn√°l√≥ helysz√≠nekr≈ël val√≥ elt√°vol√≠t√°sakor:`, error);
                throw error;
            }
        }

        async function updateUserStatus(uid, status) {
            try {
                const profileRef = doc(db, "profiles", uid);
                await updateDoc(profileRef, {
                    status: status
                });
                renderAdminPanel();
            } catch (error) {
                console.error("Hiba a felhaszn√°l√≥ st√°tusz√°nak friss√≠t√©sekor:", error);
                alert('Hiba t√∂rt√©nt a m≈±velet sor√°n.');
            }
        }

        async function updateUserRole(uid, role) {
            try {
                const profileRef = doc(db, "profiles", uid);
                await updateDoc(profileRef, {
                    role: role
                });
                renderAdminPanel();
            } catch (error) {
                console.error("Hiba a felhaszn√°l√≥ szerepk√∂r√©nek friss√≠t√©sekor:", error);
                alert('Hiba t√∂rt√©nt a m≈±velet sor√°n.');
            }
        }

        async function updateUserCanSee213(uid, canSee) {
            try {
                const profileRef = doc(db, "profiles", uid);
                await updateDoc(profileRef, {
                    canSee213: canSee
                });
                const profileSnap = await getDoc(profileRef);
                if (profileSnap.exists()) {
                    if (currentUserProfile && uid === currentUserProfile.uid) {
                        currentUserProfile.canSee213 = canSee;
                        initializeDashboard();
                    }
                }
            } catch (error) {
                console.error("Hiba a 213-as sor l√°that√≥s√°g√°nak friss√≠t√©sekor:", error);
                alert('Hiba t√∂rt√©nt a m≈±velet sor√°n.');
            }
        }

        function handleActionButtons(event) {
            const button = event.target.closest('button');
            if (!button) return;

            if (button.classList.contains('kick-btn')) {
                const memberItem = button.closest('.member-item');
                const uid = memberItem.dataset.uid;
                const userType = button.dataset.userType;
                const locationName = activeTab;

                if (uid && locationName) {
                    if (locationName === 'Rept√©r' && airportActiveSubTab === 'emirates') {
                        kickUserFromEmirates(uid, userType);
                    } else {
                        kickUserFromLocation(locationName, uid, userType);
                    }
                }
                return;
            }

            if (!activeTab) return;

            if (activeTab === 'Rept√©r') {
                switch (airportActiveSubTab) {
                    case 'airport':
                        switch (button.id) {
                            case 'check-in-btn':
                                checkIn('Rept√©r');
                                break;
                            case 'check-out-btn':
                                checkOut('Rept√©r');
                                break;
                            case 'flame-btn':
                                handleFlameClick('Rept√©r');
                                break;
                            case 'food-phone-btn':
                                handleFoodPhoneClick('Rept√©r');
                                break;
                        }
                        break;
                    case 'emirates':
                        switch (button.id) {
                            case 'emirates-check-in-btn':
                                checkInEmirates();
                                break;
                            case 'emirates-check-out-btn':
                                checkOutEmirates();
                                break;
                            case 'emirates-flame-btn':
                                handleEmiratesFlameClick();
                                break;
                            case 'emirates-food-phone-btn':
                                handleEmiratesFoodPhoneClick();
                                break;
                        }
                        break;
                }
            }
            else if (activeTab !== 'V-Oszt√°ly' && activeTab !== '213' && activeTab !== 'Profil' && activeTab !== 'Admin' && activeTab !== 'T√©rk√©p' && activeTab !== 'C√≠mkioszt√≥') {
                switch (button.id) {
                    case 'check-in-btn':
                        checkIn(activeTab);
                        break;
                    case 'check-out-btn':
                        checkOut(activeTab);
                        break;
                    case 'flame-btn':
                        handleFlameClick(activeTab);
                        break;
                    case 'food-phone-btn':
                        handleFoodPhoneClick(activeTab);
                        break;
                }
            }
        }

        async function checkInEmirates() {
            const userObject = createMemberObject(currentUserProfile);
            if (!userObject) return;

            await checkoutFromAllLocations();

            const locationRef = doc(db, "locations", "Emirates");
            try {
                await updateDoc(locationRef, {
                    members: arrayUnion(userObject)
                });
            } catch (e) {
                console.error("Hiba az Emirates bel√©ptet√©s sor√°n:", e);
            }
        }

        async function checkOutEmirates() {
            if (!currentUserProfile) return;

            const locationRef = doc(db, "locations", "Emirates");
            const docSnap = await getDoc(locationRef);
            if (!docSnap.exists()) return;

            const emiratesMembers = docSnap.data().members || [];
            const userIndex = emiratesMembers.findIndex(m => m.uid === currentUserProfile.uid);
            const memberToRemove = emiratesMembers[userIndex];

            if (memberToRemove) {
                lastCheckedOut = {
                    locationName: 'Rept√©r', // UI works under Rept√©r tab
                    memberData: memberToRemove,
                    index: userIndex,
                    memberType: 'members', // Now standard members in Emirates doc
                    subLocation: 'Emirates' // Tag for restore
                };
                const updatedMembers = emiratesMembers.filter(m => m.uid !== currentUserProfile.uid);
                try {
                    await updateDoc(locationRef, { members: updatedMembers });
                } catch (e) {
                    console.error("Hiba az Emirates kil√©ptet√©s sor√°n: ", e);
                }
            }
        }

        async function handleEmiratesFlameClick() {
            if (!lastCheckedOut ||
                lastCheckedOut.memberData.uid !== currentUserProfile.uid ||
                lastCheckedOut.subLocation !== 'Emirates') return;

            await checkoutFromAllLocations();

            const locationRef = doc(db, "locations", "Emirates");
            const docSnap = await getDoc(locationRef);
            let currentMembers = (docSnap.exists() && docSnap.data().members) ? docSnap.data().members : [];

            const memberToReinsert = {
                ...lastCheckedOut.memberData,
                displayName: 'üî• ' + lastCheckedOut.memberData.displayName.replace(/^[üî•üçîüìû\s]+/, '')
            };

            if (currentMembers.some(m => m.uid === memberToReinsert.uid)) {
                lastCheckedOut = null;
                return;
            }

            currentMembers.splice(lastCheckedOut.index, 0, memberToReinsert);

            try {
                await updateDoc(locationRef, { members: currentMembers });
                lastCheckedOut = null;
            } catch (e) {
                console.error("Hiba az Emirates vissza√°ll√≠t√°s sor√°n: ", e);
            }
        }

        async function handleEmiratesFoodPhoneClick() {
            if (!currentUserProfile) return;

            const foodPhonePrefix = 'üçîüìû ';
            const flamePrefix = 'üî• ';

            const updateUserNameInEmirates = async (newDisplayName) => {
                const locationRef = doc(db, "locations", "Emirates");
                const docSnap = await getDoc(locationRef);
                if (!docSnap.exists()) return;

                const emiratesMembers = docSnap.data().members || [];
                const updatedMembers = [...emiratesMembers];
                const userIndex = updatedMembers.findIndex(m => m.uid === currentUserProfile.uid);
                if (userIndex === -1) return;

                updatedMembers[userIndex] = {
                    ...updatedMembers[userIndex],
                    displayName: newDisplayName
                };

                await updateDoc(locationRef, { members: updatedMembers });
            };

            const locationRef = doc(db, "locations", "Emirates");
            const docSnap = await getDoc(locationRef);
            if (!docSnap.exists()) return;

            const emiratesMembers = docSnap.data().members || [];
            const userIndex = emiratesMembers.findIndex(m => m.uid === currentUserProfile.uid);
            if (userIndex === -1) return;

            const userObject = emiratesMembers[userIndex];
            let currentName = userObject.displayName;

            let baseName = currentName;
            if (baseName.startsWith(flamePrefix)) {
                baseName = baseName.substring(flamePrefix.length);
            }
            if (baseName.startsWith(foodPhonePrefix)) {
                baseName = baseName.substring(foodPhonePrefix.length);
            }

            const hasFoodPhone = currentName.includes(foodPhonePrefix);
            let newDisplayName;

            if (hasFoodPhone) {
                newDisplayName = (currentName.startsWith(flamePrefix) ? flamePrefix : '') + baseName;
            } else {
                newDisplayName = (currentName.startsWith(flamePrefix) ? flamePrefix : '') + foodPhonePrefix + baseName;
            }

            await updateUserNameInEmirates(newDisplayName);
        }

        async function kickUserFromEmirates(uid, userType) {
            const locationRef = doc(db, "locations", "Emirates");
            const docSnap = await getDoc(locationRef);
            if (docSnap.exists()) {
                const emiratesMembers = docSnap.data().members || [];
                const updatedMembers = emiratesMembers.filter(m => m.uid !== uid);
                await updateDoc(locationRef, { members: updatedMembers });
            }
        }

        async function kickUserFromLocation(locationName, uid, userType) {
            const locationRef = doc(db, "locations", locationName);
            const docSnap = await getDoc(locationRef);
            if (docSnap.exists()) {
                const members = docSnap.data().members || [];
                const updatedMembers = members.filter(m => m.uid !== uid);
                await updateDoc(locationRef, { members: updatedMembers });
            }

            if (userType === 'V-Oszt√°ly') {
                if (locationName !== 'V-Oszt√°ly') {
                    const vClassRef = doc(db, "locations", "V-Oszt√°ly");
                    const vClassSnap = await getDoc(vClassRef);
                    if (vClassSnap.exists()) {
                        const vClassMembers = vClassSnap.data().members || [];
                        const updatedVClassMembers = vClassMembers.filter(m => m.uid !== uid);
                        await updateDoc(vClassRef, { members: updatedVClassMembers });
                    }
                } else {
                    const allLocations = [...TABS];
                    for (const loc of allLocations) {
                        if (loc === 'Rept√©r') continue;
                        const locRef = doc(db, "locations", loc);
                        const locSnap = await getDoc(locRef);
                        if (locSnap.exists()) {
                            const locMembers = locSnap.data().members || [];
                            if (locMembers.some(m => m.uid === uid)) {
                                const updatedLocMembers = locMembers.filter(m => m.uid !== uid);
                                await updateDoc(locRef, { members: updatedLocMembers });
                                break;
                            }
                        }
                    }
                }
            }
        }

        function createMemberObject(profile) {
            if (!profile) return null;
            let finalDisplayName;

            switch (profile.userType) {
                case 'Taxi':
                    finalDisplayName = `${profile.username}S - ${profile.licensePlate}`;
                    break;
                case 'Kombi Taxi':
                    finalDisplayName = `${profile.username}SK - ${profile.licensePlate}`;
                    break;
                case 'V-Oszt√°ly':
                    finalDisplayName = `${profile.username}V - ${profile.licensePlate}`;
                    break;
                case 'VIP':
                    finalDisplayName = `${profile.username} - ${profile.licensePlate}`;
                    break;
                case 'VIP Kombi':
                    finalDisplayName = `${profile.username}K - ${profile.licensePlate}`;
                    break;
                default:
                    finalDisplayName = `${profile.username} - ${profile.licensePlate}`;
                    break;
            }

            return {
                uid: profile.uid,
                username: profile.username,
                userType: profile.userType,
                licensePlate: profile.licensePlate,
                displayName: finalDisplayName,
                checkInTime: new Date().toLocaleTimeString('hu-HU', { hour: '2-digit', minute: '2-digit' })
            };
        }

        async function checkIn(locationName) {
            const userObject = createMemberObject(currentUserProfile);
            if (!userObject) return;
            await checkoutFromAllLocations();
            lastCheckedOut = null;
            const locationRef = doc(db, "locations", locationName);
            try {
                await setDoc(locationRef, { members: arrayUnion(userObject) }, { merge: true });

                if (currentUserProfile.userType === 'V-Oszt√°ly' && locationName !== 'Rept√©r') {
                    const vClassRef = doc(db, "locations", "V-Oszt√°ly");
                    await setDoc(vClassRef, { members: arrayUnion(userObject) }, { merge: true });
                }
            } catch (e) { console.error("Hiba a bel√©ptet√©s sor√°n:", e); }
        }

        async function checkOut(locationName) {
            if (!currentUserProfile) return;
            const locationRef = doc(db, "locations", locationName);
            const docSnap = await getDoc(locationRef);
            if (!docSnap.exists()) return;

            const members = docSnap.data().members || [];
            const userIndex = members.findIndex(m => m.uid === currentUserProfile.uid);
            const memberToRemove = members[userIndex];

            if (memberToRemove) {
                lastCheckedOut = { locationName, memberData: memberToRemove, index: userIndex, memberType: 'members' };
                const updatedMembers = members.filter(m => m.uid !== currentUserProfile.uid);
                try {
                    await updateDoc(locationRef, { members: updatedMembers });

                    if (currentUserProfile.userType === 'V-Oszt√°ly') {
                        const vClassRef = doc(db, "locations", "V-Oszt√°ly");
                        const vClassSnap = await getDoc(vClassRef);
                        if (vClassSnap.exists()) {
                            const vClassMembers = vClassSnap.data().members || [];
                            const vClassUserIndex = vClassMembers.findIndex(m => m.uid === currentUserProfile.uid);
                            if (vClassUserIndex !== -1) {
                                const vClassMemberToRemove = vClassMembers[vClassUserIndex];
                                lastCheckedOut.vClassCheckout = {
                                    locationName: "V-Oszt√°ly",
                                    memberData: vClassMemberToRemove,
                                    index: vClassUserIndex
                                };
                                const updatedVClassMembers = vClassMembers.filter(m => m.uid !== currentUserProfile.uid);
                                await updateDoc(vClassRef, { members: updatedVClassMembers });
                            }
                        }
                    }
                } catch (e) { console.error("Hiba a kil√©ptet√©s sor√°n: ", e); }
            }
        }

        async function handleFlameClick(locationName) {
            if (!lastCheckedOut || lastCheckedOut.memberData.uid !== currentUserProfile.uid || lastCheckedOut.locationName !== locationName) return;

            await checkoutFromAllLocations();

            const locationRef = doc(db, "locations", locationName);
            const docSnap = await getDoc(locationRef);
            let currentMembers = (docSnap.exists() && docSnap.data().members) ? docSnap.data().members : [];

            const memberToReinsert = {
                ...lastCheckedOut.memberData,
                displayName: 'üî• ' + lastCheckedOut.memberData.displayName.replace(/^[üî•üçîüìû\s]+/, '')
            };

            if (currentMembers.some(m => m.uid === memberToReinsert.uid)) {
                lastCheckedOut = null;
                return;
            }

            currentMembers.splice(lastCheckedOut.index, 0, memberToReinsert);

            try {
                await updateDoc(locationRef, { members: currentMembers });

                if (lastCheckedOut.vClassCheckout) {
                    const vClassRef = doc(db, "locations", "V-Oszt√°ly");
                    const vClassSnap = await getDoc(vClassRef);
                    let vClassMembers = (vClassSnap.exists() && vClassSnap.data().members) ? vClassSnap.data().members : [];

                    if (!vClassMembers.some(m => m.uid === memberToReinsert.uid)) {
                        vClassMembers.splice(lastCheckedOut.vClassCheckout.index, 0, memberToReinsert);
                        await updateDoc(vClassRef, { members: vClassMembers });
                    }
                }

                lastCheckedOut = null;
            } catch (e) {
                console.error("Hiba a vissza√°ll√≠t√°s sor√°n: ", e);
            }
        }

        async function handleFoodPhoneClick(locationName) {
            if (!currentUserProfile) return;

            const foodPhonePrefix = 'üçîüìû ';
            const flamePrefix = 'üî• ';

            const updateUserNameAtLocation = async (locName, uid, newDisplayName) => {
                const locationRef = doc(db, "locations", locName);
                const docSnap = await getDoc(locationRef);
                if (!docSnap.exists()) return;

                const members = docSnap.data().members || [];
                const updatedMembers = [...members];
                const userIndex = updatedMembers.findIndex(m => m.uid === uid);
                if (userIndex === -1) return;

                updatedMembers[userIndex] = {
                    ...updatedMembers[userIndex],
                    displayName: newDisplayName
                };

                await updateDoc(locationRef, { members: updatedMembers });
            };

            const locationRef = doc(db, "locations", locationName);
            const docSnap = await getDoc(locationRef);
            if (!docSnap.exists()) return;

            const members = docSnap.data().members || [];
            const userIndex = members.findIndex(m => m.uid === currentUserProfile.uid);
            if (userIndex === -1) return;

            const userObject = members[userIndex];
            let currentName = userObject.displayName;

            let baseName = currentName;
            if (baseName.startsWith(flamePrefix)) {
                baseName = baseName.substring(flamePrefix.length);
            }
            if (baseName.startsWith(foodPhonePrefix)) {
                baseName = baseName.substring(foodPhonePrefix.length);
            }

            const hasFoodPhone = currentName.includes(foodPhonePrefix);
            let newDisplayName;

            if (hasFoodPhone) {
                newDisplayName = (currentName.startsWith(flamePrefix) ? flamePrefix : '') + baseName;
            } else {
                newDisplayName = (currentName.startsWith(flamePrefix) ? flamePrefix : '') + foodPhonePrefix + baseName;
            }

            await updateUserNameAtLocation(locationName, currentUserProfile.uid, newDisplayName);

            if (currentUserProfile.userType === 'V-Oszt√°ly' && locationName !== 'Rept√©r') {
                await updateUserNameAtLocation('V-Oszt√°ly', currentUserProfile.uid, newDisplayName);
            }
        }

        async function checkoutFromAllLocations() {
            if (!currentUserProfile) return;
            const batch = writeBatch(db);

            const allLocations = [...TABS, 'V-Oszt√°ly'];
            const readPromises = allLocations.map(ln => getDoc(doc(db, "locations", ln)));
            const locationSnapshots = await Promise.all(readPromises);

            locationSnapshots.forEach((docSnap, index) => {
                if (docSnap.exists()) {
                    const members = docSnap.data().members || [];
                    if (members.some(m => m.uid === currentUserProfile.uid)) {
                        const updatedMembers = members.filter(m => m.uid !== currentUserProfile.uid);
                        const locationRef = doc(db, "locations", allLocations[index]);
                        batch.update(locationRef, { members: updatedMembers });
                    }
                }
            });

            const airportRef = doc(db, "locations", "Rept√©r");
            const airportSnap = await getDoc(airportRef);
            if (airportSnap.exists()) {
                const data = airportSnap.data();
                const updatedData = {};
                let needsUpdate = false;

                if (data.members && data.members.some(m => m.uid === currentUserProfile.uid)) {
                    updatedData.members = data.members.filter(m => m.uid !== currentUserProfile.uid);
                    needsUpdate = true;
                }
                if (data.emiratesMembers && data.emiratesMembers.some(m => m.uid === currentUserProfile.uid)) {
                    // Deprecated: Clean up old emiratesMembers from Rept√©r if found
                    updatedData.emiratesMembers = data.emiratesMembers.filter(m => m.uid !== currentUserProfile.uid);
                    needsUpdate = true;
                }

                if (needsUpdate) {
                    batch.update(airportRef, updatedData);
                }
            }

            // Also check out from standalone Emirates
            const emiratesRef = doc(db, "locations", "Emirates");
            const emiratesSnap = await getDoc(emiratesRef);
            if (emiratesSnap.exists()) {
                const members = emiratesSnap.data().members || [];
                if (members.some(m => m.uid === currentUserProfile.uid)) {
                    const updatedMembers = members.filter(m => m.uid !== currentUserProfile.uid);
                    batch.update(emiratesRef, { members: updatedMembers });
                }
            }

            try {
                await batch.commit();
            } catch (e) {
                console.error("Hiba az √∂sszes helyr≈ël val√≥ kil√©ptet√©skor:", e);
                throw e;
            }
        }

        function mapAuthCodeToMessage(code) {
            switch (code) {
                case 'auth/operation-not-allowed': return 'A m≈±velet nem enged√©lyezett. Enged√©lyezd az Email/Jelsz√≥ bejelentkez√©st a Firebase konzolon.';
                case 'auth/user-not-found': case 'auth/wrong-password': case 'auth/invalid-credential': return 'Hib√°s felhaszn√°l√≥n√©v vagy jelsz√≥.';
                case 'auth/email-already-in-use': return 'Ez a felhaszn√°l√≥n√©v m√°r foglalt.';
                case 'auth/weak-password': return 'A jelsz√≥nak legal√°bb 6 karakter hossz√∫nak kell lennie.';
                case 'auth/too-many-requests': return 'T√∫l sok pr√≥b√°lkoz√°s. Pr√≥b√°ld √∫jra k√©s≈ëbb.';
                default: return `Ismeretlen hiba t√∂rt√©nt: ${code}`;
            }
        }

    </script>
</body>

</html>